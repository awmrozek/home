<script type="text/javascript" language="JavaScript"><!--  document.write (unescape ('%3cscript type="text/javascript" '+' src="http://kropka.onet.pl/_s/kropka/r.js?id=B8XlFCO1yU.kxYbVHvZDL8Q8HSeKoi8AdrFAxSxBYoj.s7&t=1&z=0&k=0&RR='+(new Date()).getTime()+'"%3e%3c/script%3e'));  //--></script> 
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
<head>
  <meta http-equiv="content-type"
 content="text/html; charset=windows-1250">
  <meta name="Language" content="pl">
  <meta name="Author" content="Twój nocny koszmar">
  <meta name="Generator" content="Notatnik :-)">
  <style type="text/css">
<!--
body { color: #000000; background-color: #000000; }
.cpp1-assembler { color: #00FF00; }
.cpp1-character { color: #FF00FF; }
.cpp1-comment { color: #969696; font-style: italic; }
.cpp1-float { color: #FF00FF; }
.cpp1-hexadecimal { color: #FF00FF; }
.cpp1-identifier { color: #00FF00; }
.cpp1-illegalchar { background-color: #800000; color: #FF0000; }
.cpp1-number { color: #FF00FF; }
.cpp1-octal { color: #FF00FF; }
.cpp1-preprocessor { color: #00FF00; }
.cpp1-reservedword { color: #3366FF; font-weight: bold; }
.cpp1-space { background-color: #464646; color: #FFFFFF; }
.cpp1-string { color: #FF00FF; }
.cpp1-symbol { color: #FFFF00; }
-->
  </style>
  <title>Dark Cult of C++ - WinAPI - TreeView</title>
  <link rel="stylesheet" href="kurs.css" type="text/css">
</head>
<body
 style="font-family: Verdana; font-size: 9pt; color: rgb(204, 204, 204); background-color: rgb(70, 70, 70);">
<table align="center">
  <tbody>
    <tr>
      <td class="TDN">
      <a href="apitool3.html">&lt;&lt; Toolbary, cz.3</a> &nbsp;
      <a href="../winapi.html">Spis</a> &nbsp;
      <a href="../index.html" target="_top">Strona g³ówna</a> &nbsp;
      <a href="apitray.html">Tray &gt;&gt;</a> &nbsp;
      </td>
    </tr>
  </tbody>
</table>
<hr color="GRAY" width="90%" size="1">


<h2>
Tworzenie drzewa
</h2>

<p>Jest to jedna z najprzydatniejszych kontrolek (wiele rzeczy mo¿na
przedstawiæ za pomoc¹ drzewiastej struktury), a zarazem jedna z
najtrudniejszych w u¿yciu w niektórych swoich aspektach. A przynajmniej
tak by wynika³o z licznych pytañ o ni¹ na ró¿nych forach internetowych.
Za chwilê przekonamy siê, ¿e nie taki diabe³ straszny.
TreeView, czyli po prostu drzewo, wygl¹da mniej wiêcej tak:</p>

<p align=center><img src="..\gfx\treeview.gif" alt="Drzewko obrazuj¹ce strukturê folderów w Eksploratorze Windows"></p>


<p>
Tworzymy je oczywiœcie za pomoc¹ CreateWindowEx, podaj¹c jako nazwê
klasy sta³¹ <code>WC_TREEVIEW</code> albo ³añcuch<code> "SysTreeView"</code>:
</p>
<pre><code><span
 style="font-family: Courier New; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10pt; line-height: normal; font-size-adjust: none; font-stretch: normal;"><span
 class="cpp1-identifier">HWND</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">hTree</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">CreateWindowEx</span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">WS_EX_CLIENTEDGE</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">WC_TREEVIEW</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-string">"Drzefko"</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">WS_CHILD</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">|</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">WS_VISIBLE</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">|</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">WS_BORDER<br></span><span class="cpp1-space">    </span><span
 class="cpp1-symbol">|</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TVS_HASBUTTONS</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">|</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TVS_HASLINES</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">|</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TVS_LINESATROOT</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol"><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-number">5</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-number">5</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-number">300</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-number">450</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">g_hwnd</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">HMENU</span><span
 class="cpp1-symbol">)</span><span class="cpp1-number">1001</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">hThisInstance</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">NULL</span><span
 class="cpp1-symbol">);<br></span></span>
</span></code></pre>
<p>
Oczywiœcie efekt takiego zabiegu jest na razie ma³o imponuj¹cy, bowiem
otrzymaliœmy tylko pusty prostok¹t. Aby dodaæ jakieœ elementy do
drzewa, musimy zaznajomiæ siê ze struktur¹ <code>TVITEM</code>, która
(jak sama nazwa wskazuje) reprezentuje pojedynczy element drzewa. Oto
ona:
</p>
<pre><code><span
 style="font-family: Courier New; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10pt; line-height: normal; font-size-adjust: none; font-stretch: normal;"><span
 class="cpp1-reservedword">typedef</span><span class="cpp1-space"> </span><span
 class="cpp1-reservedword">struct</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">tagTVITEM</span><span class="cpp1-space"> <br></span><span
 class="cpp1-symbol">{<br></span><span class="cpp1-space">    </span><span
 class="cpp1-identifier">UINT</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">mask</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-space">    </span><span class="cpp1-identifier">HTREEITEM</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">hItem</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-space">    </span><span
 class="cpp1-identifier">UINT</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">state</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-space">    </span><span class="cpp1-identifier">UINT</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">stateMask</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-space">    </span><span
 class="cpp1-identifier">LPTSTR</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">pszText</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-space">    </span><span class="cpp1-reservedword">int</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">cchTextMax</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-space">    </span><span
 class="cpp1-reservedword">int</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">iImage</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-space">    </span><span class="cpp1-reservedword">int</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">iSelectedImage</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-space">    </span><span
 class="cpp1-reservedword">int</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">cChildren</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-space">    </span><span class="cpp1-identifier">LPARAM</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">lParam</span><span
 class="cpp1-symbol">;<br>}</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TVITEM</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">*</span><span
 class="cpp1-identifier">LPTVITEM</span><span class="cpp1-symbol">;<br></span></span>
</code></pre>
<p>
Najwa¿niejsze pole to <code>mask</code> - okreœla ono, które z
pozosta³ych pól s¹ prawid³owe i mog¹ byæ wykorzystane. Struktura <code>TVITEM</code>
mo¿e byæ wykorzystana podczas dodawania elementu b¹dŸ do
pobierania/ustawiania informacji o nim. Mog¹ to byæ dowolnie (prawie)
przez nas wybrane informacje i w³aœnie dlatego stosuje siê tutaj maskê.
</p>
<p>
Pole <code>hItem</code> przydaje siê, kiedy chcemy zmodyfikowaæ ju¿
istniej¹cy element, np. zmieniæ jego tekst. Podczas dodawania nowego
elementu pole to nie jest wykorzystywane.
</p>
<p>
Pola <code>pszText</code> i <code>cchTextMask</code>, jak same ich
nazwy wskazuj¹, pozwalaj¹ ustawiæ tekst elementu. Jeœli pole mask ma
ustawion¹ flagê <code>TVIF_TEXT</code>, to oznacza, ¿e zarówno<code>
pszText</code>, jak i <code>cchTextMask</code> zawieraj¹ prawid³owe
wartoœci (jednak wartoœæ <code>cchTextMask</code> wykorzystywana jest
tylko do pobierania informacji o elemencie, zaœ gdy struktura s³u¿y do
ustawiania informacji, wówczas to pole jest ignorowane).
</p>
<p>
Pola <code>iImage</code> oraz <code>iSelectedImage</code> pozwalaj¹
ustawiæ ikonki, wyœwietlane po lewej stronie tekstu elementu.
</p>
<p>
Pole <code>cChildren</code> udostêpnia nam informacjê, ile dzieci
zawiera dany element (tj. ile elementów jest bezpoœrednio "pod" nim).
</p>
<p>
Wreszcie ostatnie pole, <code>lParam</code>, pozostaje ca³kowicie do
naszej dyspozycji. Typowym jego przeznaczeniem jest przechowywanie
wskaŸnika na jak¹œ strukturê, zawieraj¹c¹ dalsze informacje. Dziêki
temu nie musimy implementowaæ w naszym programie osobnej drzewiastej
struktury, gdy¿ wszystkie informacje o drzewie mo¿emy wrzuciæ do
struktury wskazywanej przez <code>lParam</code>.
</p>
<p>
Najwy¿sza pora dowiedzieæ siê, jak siê dodaje element. Na dobry
pocz¹tek zadowolimy siê elementami tekstowymi, bez ikonek. Niestety,
musimy siê tu zapoznaæ z kolejn¹ struktur¹ - krótsz¹ ni¿ poprzednia,
ale deklarowan¹ w trochê bardziej zawik³any sposób:
</p>
<pre><code><span
 style="font-family: Courier New; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10pt; line-height: normal; font-size-adjust: none; font-stretch: normal;"><span
 class="cpp1-reservedword">typedef</span><span class="cpp1-space"> </span><span
 class="cpp1-reservedword">struct</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">tagTVINSERTSTRUCT<br></span><span
 class="cpp1-symbol">{<br></span><span class="cpp1-space">    </span><span
 class="cpp1-identifier">HTREEITEM</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">hParent</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-space">    </span><span class="cpp1-identifier">HTREEITEM</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">hInsertAfter</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-preprocessor">#if (_WIN32_IE &gt;= 0x0400)<br></span><span
 class="cpp1-space">    </span><span class="cpp1-reservedword">union<br></span><span
 class="cpp1-space">    </span><span class="cpp1-symbol">{<br></span><span
 class="cpp1-space">        </span><span class="cpp1-identifier">TVITEMEX</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">itemex</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-space">        </span><span
 class="cpp1-identifier">TVITEM</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">item</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-space">    </span><span class="cpp1-symbol">}</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">DUMMYUNIONNAME</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-preprocessor">#else<br></span><span
 class="cpp1-space">    </span><span class="cpp1-identifier">TVITEM</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">item</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-preprocessor">#endif<br></span><span
 class="cpp1-symbol">}</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TVINSERTSTRUCT</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">*</span><span
 class="cpp1-identifier">LPTVINSERTSTRUCT</span><span
 class="cpp1-symbol">;<br></span></span>
</code></pre>
<p>
Jak widzimy, podstawowe sk³adniki struktury <code>TVINSERTSTRUCT</code>
to uchwyty: <code>hParent</code> i <code>hInsertAfter</code>, oraz
struktura, któr¹ ju¿ znamy, zawieraj¹ca informacje o wstawianym
elemencie. Pole <code>hParent</code> okreœla, jaki element bêdzie
rodzicem elementu w³aœnie wstawianego, zaœ <code>hInsertAfter</code> -
jaka bêdzie jego pozycja wzglêdem ewentualnego "rodzeñstwa" (elementów
maj¹cych tego samego rodzica).
</p>
<p>
Widzimy równie¿, ¿e na systemach z zainstalowanym Internet Explorerem w
wersji 4.0 i wy¿szej (czyli praktycznie we wszystkich obecnie
spotykanych wersjach Windows :-) ) mamy mo¿liwoœæ, by zamiast <code>TVITEM</code>
u¿yæ <code>TVITEMEX</code>. Ró¿nica miêdzy tymi dwiema strukturami nie
jest wszak¿e na tyle istotna, by sobie ni¹ tutaj zawracaæ g³owê :-).
</p>
<p>
Wiemy, na czym bêdziemy operowaæ, zatem do dzie³a. Najpierw wype³nijmy
strukturê informacji o elemencie:
</p>
<pre><code><span
 style="font-family: Courier New; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10pt; line-height: normal; font-size-adjust: none; font-stretch: normal;"><span
 class="cpp1-identifier">TVITEM</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">tvi</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-identifier">tvi</span><span class="cpp1-symbol">.</span><span
 class="cpp1-identifier">mask</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TVIF_TEXT</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-identifier">tvi</span><span class="cpp1-symbol">.</span><span
 class="cpp1-identifier">pszText</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-string">"Element Jeden"</span><span class="cpp1-symbol">;<br></span></span>
</code></pre>
<p>
Teraz gotow¹ strukturê mo¿emy wrzuciæ do odpowiedniego pola struktury <code>TVINSERTSTRUCT</code>,
a tak¿e okreœliæ w tej ostatniej pozycjê, gdzie wyl¹duje nasz nowy
element. Poniewa¿ na razie bêdzie to jedyny element na drzewie, wiêc
nie mamy zbyt wielkiego wyboru. Mo¿e on byæ tylko przypiêty do korzenia
drzewa. W tym celu zamiast "normalnego" uchwytu dajemy sta³¹ <code>TVI_ROOT</code>
albo po prostu <code>NULL</code>. Podobnie postêpujemy z polem <code>hInsertAfter</code>:
</p>
<pre><code><span
 style="font-family: Courier New; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10pt; line-height: normal; font-size-adjust: none; font-stretch: normal;"><span
 class="cpp1-identifier">TVINSERTSTRUCT</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">tvins</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-identifier">tvis</span><span class="cpp1-symbol">.</span><span
 class="cpp1-identifier">item</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">tvi</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-identifier">tvis</span><span class="cpp1-symbol">.</span><span
 class="cpp1-identifier">hParent</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">tvis</span><span class="cpp1-symbol">.</span><span
 class="cpp1-identifier">hInsertAfter</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TVI_ROOT</span><span class="cpp1-symbol">;<br></span></span>
</code></pre>
<p>
Dalszy ci¹g jest ju¿ bardzo prosty - wystarczy wywo³aæ makro <code>TreeView_InsertItem</code>
z adresem naszej struktury <code>tvis</code>. Makro wyœle komunikat <code>TVM_INSERTITEM</code>
(mo¿emy to te¿ zrobiæ bezpoœrednio, tylko po co?).
</p>
<pre><code><span
 style="font-family: Courier New; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10pt; line-height: normal; font-size-adjust: none; font-stretch: normal;"><span
 class="cpp1-identifier">HTREEITEM</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">hItem1</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TreeView_InsertItem</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">hTree</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">&amp;</span><span class="cpp1-identifier">tvis</span><span
 class="cpp1-symbol">);<br></span></span>
</code></pre>
<p>
Element ju¿ dodany, dostaliœmy te¿ do niego uchwyt (<code>hItem</code>).
¯eby taki listek nie usech³ z têsknoty, mo¿emy mu w trybie
natychmiastowym wyhodowaæ trochê rodzeñstwa i potomstwa:
</p>
<pre><code><span
 style="font-family: Courier New; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10pt; line-height: normal; font-size-adjust: none; font-stretch: normal;"><span
 class="cpp1-identifier">tvi</span><span class="cpp1-symbol">.</span><span
 class="cpp1-identifier">pszText</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-string">"Element Dwa"</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-identifier">tvis</span><span class="cpp1-symbol">.</span><span
 class="cpp1-identifier">item</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">tvi</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-identifier">tvis</span><span class="cpp1-symbol">.</span><span
 class="cpp1-identifier">hInsertAfter</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TVI_LAST</span><span class="cpp1-symbol">;</span><span
 class="cpp1-space"> </span><span class="cpp1-comment">// ...albo hItem1<br></span><span
 class="cpp1-identifier">HTREEITEM</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">hItem2</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TreeView_InsertItem</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">hTree</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">&amp;</span><span class="cpp1-identifier">tvis</span><span
 class="cpp1-symbol">);<br><br></span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">pszText</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-string">"Element Trzy"</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-identifier">tvis</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">item</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-identifier">tvis</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">hInsertAfter</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">TVI_LAST</span><span
 class="cpp1-symbol">;</span><span class="cpp1-space"> </span><span
 class="cpp1-comment">// ...albo hItem2<br></span><span
 class="cpp1-identifier">HTREEITEM</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">hItem3</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TreeView_InsertItem</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">hTree</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">&amp;</span><span class="cpp1-identifier">tvis</span><span
 class="cpp1-symbol">);<br><br></span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">pszText</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-string">"Dziecko Elementu Jeden"</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-identifier">tvis</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">item</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-identifier">tvis</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">hParent</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">hItem1</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-identifier">tvis</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">hInsertAfter</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">TVI_FIRST</span><span
 class="cpp1-symbol">;</span><span class="cpp1-space"> </span><span
 class="cpp1-comment">// ...albo TVI_LAST<br></span><span
 class="cpp1-identifier">HTREEITEM</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">hItemChild</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TreeView_InsertItem</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">hTree</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">&amp;</span><span class="cpp1-identifier">tvis</span><span
 class="cpp1-symbol">);<br></span></span>
</code></pre>
<p>
Mieliœmy tu trochê zabawy z ustalaniem hierarchii nowo dodawanych
elementów, co mniej wiêcej powinno daæ obraz, jak siê to robi. Warto
wspomnieæ o jeszcze jednym bajerze - pole <code>hInsertAfter</code>
mo¿emy równie¿ ustawiæ na <code>TVI_SORT</code>, co pozwoli nam na
alfabetyczne sortowanie dodawanych elementów. Zwróæ uwagê, ¿e aby
posortowaæ ca³e drzewo, musimy wszystkie jego elementy dodaæ z <code>hInsertAfter</code>
ustawionym na <code>TVI_SORT</code>.
</p>
<h2>
Ikonki elementów
</h2>
<p>
Przedstawienie niektórych danych w postaci drzewa z pewnoœci¹ znacznie
poprawia ich czytelnoœæ, ale czegoœ nam tu wyraŸnie brakuje. Chodzi
oczywiœcie o ikonki. Mo¿emy narysowaæ w³asne albo u¿yæ systemowych
ikon. W obu przypadkach musimy skorzystaæ z us³ug innej kontrolki - <code>ImageList</code>.
Nie jest ona, w odró¿nieniu od wiêkszoœci kontrolek, elementem
graficznego interfejsu i nie posiada swojej graficznej reprezentacji.
S³u¿y wy³¹cznie do przechowywania wielu bitmap w pamiêci i ogólnie
zarz¹dzania nimi.
</p>
<p>Na szczêœcie obs³uga takich list nie nale¿y do szczególnie trudnych
zadañ. Najpierw tworzymy listê za pomoc¹ funkcji <code>ImageList_Create</code>,
nastêpnie poszczególne obrazki wczytujemy i dodajemy na listê za pomoc¹
<code>ImageList_Add</code>, np.:
</p>
<pre><code><span
 style="font-family: Courier New; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10pt; line-height: normal; font-size-adjust: none; font-stretch: normal;"><span
 class="cpp1-identifier">HIMAGELIST</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">himl</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-identifier">HBITMAP</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">hbmp<br>SHORT</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">nLeaf</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">nNodeClosed</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">nNodeOpen</span><span class="cpp1-symbol">;<br><br></span><span
 class="cpp1-identifier">himl</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">ImageList_Create</span><span
 class="cpp1-symbol">(</span><span class="cpp1-number">16</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-number">16</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">FALSE</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-number">3</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-number">0</span><span
 class="cpp1-symbol">));<br><br></span><span class="cpp1-identifier">hbmp</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">LoadBitmap</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">g_hinst</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">MAKEINTRESOURCE</span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">IDB_LEAF</span><span class="cpp1-symbol">));</span><span
 class="cpp1-space"> <br></span><span class="cpp1-identifier">nLeaf</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">ImageList_Add</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">himl</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">hbmp</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">HBITMAP</span><span class="cpp1-symbol">)</span><span
 class="cpp1-identifier">NULL</span><span class="cpp1-symbol">);</span><span
 class="cpp1-space"> <br></span><span class="cpp1-identifier">DeleteObject</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">hbmp</span><span
 class="cpp1-symbol">);</span><span class="cpp1-space"> <br></span><span
 class="cpp1-identifier">hbmp</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">LoadBitmap</span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">g_hinst</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">MAKEINTRESOURCE</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">IDB_NODECLOSED</span><span
 class="cpp1-symbol">));</span><span class="cpp1-space"> <br></span><span
 class="cpp1-identifier">nNodeClosed</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">ImageList_Add</span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">himl</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">hbmp</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">HBITMAP</span><span
 class="cpp1-symbol">)</span><span class="cpp1-identifier">NULL</span><span
 class="cpp1-symbol">);</span><span class="cpp1-space"> <br></span><span
 class="cpp1-identifier">DeleteObject</span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">hbmp</span><span class="cpp1-symbol">);</span><span
 class="cpp1-space"> <br></span><span class="cpp1-identifier">hbmp</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">LoadBitmap</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">g_hinst</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">MAKEINTRESOURCE</span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">IDB_NODEOPEN</span><span class="cpp1-symbol">));</span><span
 class="cpp1-space"> <br></span><span class="cpp1-identifier">nNodeOpen</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">ImageList_Add</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">himl</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">hbmp</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">HBITMAP</span><span class="cpp1-symbol">)</span><span
 class="cpp1-identifier">NULL</span><span class="cpp1-symbol">);</span><span
 class="cpp1-space"> <br></span><span class="cpp1-identifier">DeleteObject</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">hbmp</span><span
 class="cpp1-symbol">);</span><span class="cpp1-space"> <br><br></span><span
 class="cpp1-identifier">TreeView_SetImageList</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">hTree</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">himl</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">TVSIL_NORMAL</span><span
 class="cpp1-symbol">);</span><span class="cpp1-space"> <br></span></span>
</code></pre>
<p>
Pierwsze dwa parametry funkcji <code>ImageList_Create</code> to
wymiary obrazka. Trzeci to flagi - nie u¿ywamy ich tutaj. Pozosta³e dwa
parametry oznaczaj¹ odpowiednio: liczbê obrazków, jakie pocz¹tkowo
znajduj¹ siê na liœcie oraz o ile lista mo¿e siê rozszerzyæ w
niedalekiej przysz³oœci. Oba te parametry maj¹ znaczenie w
optymalizacji dzia³ania naszego programu w systemie.
</p>
<p>
Po dodaniu wszystkich trzech obrazków (tyle zazwyczaj potrzebujemy dla
drzewa, choæ oczywiœcie mo¿e ich byæ wiêcej) musimy jeszcze przypisaæ
stworzon¹ w³aœnie listê obrazków do naszego TreeView, co czynimy w
ostatniej linijce powy¿szego przyk³adu. Teraz mo¿emy zmodyfikowaæ
elementy naszego drzewka, przypisuj¹c im odpowiednie indeksy obrazków z
listy.
</p>
<p>
Ale sk¹d wzi¹æ systemowe ikonki - takie, jakie wystêpuj¹ np. w liœcie
folderów Eksploratora Windows? Có¿, wygl¹da na to, ¿e twórcy naszego
kochanego systemu nie zatroszczyli siê o jakiœ ³atwy sposób, a ju¿
zw³aszcza o udokumentowanie poszczególnych ikon. Nic to jednak,
poradzimy sobie. Przede wszystkim musimy wywo³aæ <code>Shell_GetImageLists</code>.
Funkcja powinna wystêpowaæ we wszystkich wersjach Windowsów od 95 w
górê, chocia¿ w dokumentacji jest napisane, ¿e istnieje tylko pod XP.
Niestety, aby odwo³aæ siê do niej z wczeœniejszej wersji Windows,
musimy zrobiæ parê sztuczek:
</p>
<pre><code><span
 style="font-family: Courier New; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10pt; line-height: normal; font-size-adjust: none; font-stretch: normal;"><span
 class="cpp1-reservedword">typedef</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">BOOL</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">WINAPI</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">*</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">SHGIL_PROC</span><span
 class="cpp1-symbol">)</span><span class="cpp1-space">	</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">HIMAGELIST</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">*</span><span
 class="cpp1-identifier">phLarge</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">HIMAGELIST</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">*</span><span
 class="cpp1-identifier">phSmall</span><span class="cpp1-symbol">);<br></span><span
 class="cpp1-reservedword">typedef</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">BOOL</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">WINAPI</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">*</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">FII_PROC</span><span
 class="cpp1-symbol">)</span><span class="cpp1-space">	</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">BOOL</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">fFullInit</span><span
 class="cpp1-symbol">);<br></span></span>
</code></pre>
<p>
Te dwa typy wskaŸników do funkcji bêd¹ nam potrzebne, aby "wyci¹gn¹æ"
potrzebn¹ nam funkcjê z pliku shell32.dll. Przypominam, ¿e nie musimy
tego robiæ pod Windows XP, ale warto stosowaæ tê metodê dla zachowania
kompatybilnoœci naszej aplikacji wstecz. Z kolei pod Oknami klasy NT
wystêpuje inna trudnoœæ - aby móc skorzystaæ z systemowej listy
obrazków, musimy najpierw wywo³aæ funkcjê (nieudokumentowan¹!) <code>FileIconInit</code>.
Nie ma jej w systemach 95/98/ME, wiêc ten fakt równie¿ musimy
uwzglêdniæ.
</p>
<p>
Teraz mo¿emy pobraæ adresy funkcji<code> Shell_GetImageLists</code> i <code>FileIconInit</code>.
Jeœli czyta³eœ ju¿ odcinek o DLL, nie sprawi ci to wielkiego problemu.
Jednak i tu tkwi pewien haczyk. Otó¿ funkcji tych nie mo¿emy (na
okreœlonych platformach) pobraæ po nazwie. Musimy znaæ ich numery
porz¹dkowe (ang. ordinals). U nas wynosz¹ one, odpowiednio: <code>71</code>
i <code>660</code>. Jeœli interesuj¹ ciê inne funkcje, które w pewnych
wersjach Windows "istnia³y tylko jako numery", ich pe³n¹ listê
znajdziesz na 
<a
 href="http://members.ozemail.com.au/%7Egeoffch@ozemail.com.au/samples/win32/shell/shell32/functions/names600.htm">tej stronie.</a>
</p>
<pre><code><span
 style="font-family: Courier New; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10pt; line-height: normal; font-size-adjust: none; font-stretch: normal;"><span
 class="cpp1-identifier">HIMAGELIST</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">himlLarge</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">himlSmall</span><span
 class="cpp1-symbol">;<br><br></span><span class="cpp1-identifier">SHGIL_PROC</span><span
 class="cpp1-space">	</span><span class="cpp1-identifier">Shell_GetImageLists</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-identifier">FII_PROC</span><span
 class="cpp1-space">	</span><span class="cpp1-identifier">FileIconInit</span><span
 class="cpp1-symbol">;<br><br></span><span class="cpp1-reservedword">if</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">g_hShell32</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">==</span><span
 class="cpp1-space"> </span><span class="cpp1-number">0</span><span
 class="cpp1-symbol">)</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">g_hShell32</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">LoadLibrary</span><span class="cpp1-symbol">(</span><span
 class="cpp1-string">"shell32.dll"</span><span class="cpp1-symbol">);<br><br></span><span
 class="cpp1-identifier">Shell_GetImageLists</span><span
 class="cpp1-space">  </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">SHGIL_PROC</span><span class="cpp1-symbol">)</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">GetProcAddress</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">g_hShell32</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">LPCSTR</span><span
 class="cpp1-symbol">)</span><span class="cpp1-number">71</span><span
 class="cpp1-symbol">);<br></span><span class="cpp1-identifier">FileIconInit</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">FII_PROC</span><span class="cpp1-symbol">)</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">GetProcAddress</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">g_hShell32</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">LPCSTR</span><span
 class="cpp1-symbol">)</span><span class="cpp1-number">660</span><span
 class="cpp1-symbol">);<br></span></span>
</code></pre>
<p>
Zwróæ uwagê, ¿e uchwyt do biblioteki shell32.dll jest globalny. Wynika
to st¹d, ¿e nie mo¿emy zwolniæ tej biblioteki przed zakoñczeniem naszej
aplikacji - w przeciwnym razie zostan¹ zniszczone nasze listy z
obrazkami, co oczywiœcie nie by³oby rzecz¹ po¿¹dan¹ :-).
</p>
<pre><code><span
 style="font-family: Courier New; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10pt; line-height: normal; font-size-adjust: none; font-stretch: normal;"><span
 class="cpp1-identifier">HMODULE</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">g_hShell32</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">NULL</span><span class="cpp1-symbol">;<br></span></span>
</code></pre>
<p>
Teraz pozostaje nam jedynie wywo³aæ otrzymane z takim trudem funkcje w
celu uzyskania dostêpu do systemowych list obrazków. Jak ju¿ pewnie
zauwa¿y³eœ, s¹ a¿ dwie takie listy - jedna zawiera normalne ikonki
(32x32), druga - ich miniatury (16x16).
</p>
<pre><code><span
 style="font-family: Courier New; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10pt; line-height: normal; font-size-adjust: none; font-stretch: normal;"><span
 class="cpp1-reservedword">if</span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">FileIconInit</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">!=</span><span class="cpp1-space"> </span><span
 class="cpp1-number">0</span><span class="cpp1-symbol">)</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">FileIconInit</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">TRUE</span><span
 class="cpp1-symbol">);</span><span class="cpp1-space"> </span><span
 class="cpp1-comment">//funkcja obecna tylko w Windows NT<br><br></span><span
 class="cpp1-identifier">Shell_GetImageLists</span><span
 class="cpp1-symbol">(&amp;</span><span class="cpp1-identifier">himlLarge</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">&amp;</span><span class="cpp1-identifier">himlSmall</span><span
 class="cpp1-symbol">);<br></span></span>
</code></pre>
<p>
Zgodnie z tym, co powiedzieliœmy sobie wczeœniej, <code>FileIconInit </code>wystêpuje
tylko w serii NT, zatem jeœli nie uda siê pobraæ jej adresu (bêdzie on
równy <code>0</code>), to oczywiœcie nie wywo³ujemy jej.
</p>
<p>
Mamy wreszcie uchwyty list z obrazkami. Problem w tym, ¿e wci¹¿ nie
wiemy, co w³aœciwie siê na tych listach znajduje. Jak ju¿ wspomnia³em,
Microsoft nie pofatygowa³ siê z udokumentowaniem gdziekolwiek ich
zawartoœci. Jedynym zatem sposobem pozostaje napisanie programu, który
wyœwietli wszystkie ikony systemowe z listy. Na szczêœcie ktoœ ju¿ to
zrobi³ za nas - <a href="http://www.catch22.net/tuts/sysimg.asp">http://www.catch22.net/tuts/sysimg.asp</a>.
To w³aœnie z tej stronki pochodzi omówiony przez nas przed chwil¹
sposób dobrania siê do systemowych obrazków. Jest tam te¿ do
œci¹gniêcia przyk³adowy program, który w³aœnie wyœwietla pe³n¹ listê
systemowych ikon. Jak nietrudno zauwa¿yæ, oprócz tych stricte
systemowych widniej¹ tam równie¿ ikony dodane przez rozmaite programy,
które zainstalowaliœmy na naszym komputerze. Nas jednak interesuje
tylko pocz¹tek tej listy i ikonki: pliku (indeks 0), zamkniêtego (3) i
otwartego (4) foldera. Mo¿emy teraz wreszcie ustawiæ te indeksy
elementom drzewa. Zaczniemy oczywiœcie od przypisania jednej z dwóch
otrzymanych list (u¿yjemy tylko ma³e ikony) drzewu:
</p>
<pre><code><span
 style="font-family: Courier New; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10pt; line-height: normal; font-size-adjust: none; font-stretch: normal;"><span
 class="cpp1-identifier">TreeView_SetImageList</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">hTree</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">himlSmall</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">TVSIL_NORMAL</span><span
 class="cpp1-symbol">);</span><span class="cpp1-space"> <br></span></span>
</code></pre>
<p>
Teraz ustawimy indeksy. Przy okazji dowiemy siê, jak modyfikowaæ
istniej¹ce ju¿ elementy drzewa oraz jak mo¿na wykorzystaæ pole<code>
lParam</code> struktury <code>TVITEM</code>. W tym celu zadeklarujemy
sobie strukturê <code>TEST</code> (nie bêdziemy jej do niczego
u¿ywaæ), a wskaŸnik do zmiennej typu <code>TEST</code> zapamiêtamy w
polu <code>lParam</code> ka¿dego elementu drzewa. Do dzie³a:
</p>
<pre><code><span
 style="font-family: Courier New; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10pt; line-height: normal; font-size-adjust: none; font-stretch: normal;"><span
 class="cpp1-reservedword">struct</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TEST<br></span><span class="cpp1-symbol">{<br></span><span
 class="cpp1-space"> </span><span class="cpp1-reservedword">int</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">Bla</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-space"> </span><span
 class="cpp1-reservedword">char</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">BlaBla</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-space"> </span><span class="cpp1-reservedword">double</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">BlaBlaBla</span><span
 class="cpp1-symbol">;<br>};<br><br></span><span class="cpp1-identifier">TEST</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">Tab</span><span
 class="cpp1-symbol">[</span><span class="cpp1-number">4</span><span
 class="cpp1-symbol">];<br><br></span><span class="cpp1-identifier">TVITEM</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">mask</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">TVIW_HANDLE</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">|</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">TVIF_IMAGE</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">|</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">TVIF_SELECTEDIMAGE</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">|</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">TVIF_PARAM</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">iImage</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">iSelectedImage</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-number">3</span><span
 class="cpp1-symbol">;<br><br></span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">hItem</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">hItem1</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">lParam</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">LPARAM</span><span class="cpp1-symbol">)</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">&amp;</span><span
 class="cpp1-identifier">Tab</span><span class="cpp1-symbol">[</span><span
 class="cpp1-number">0</span><span class="cpp1-symbol">];<br></span><span
 class="cpp1-identifier">TreeView_SetItem</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">hTree</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">&amp;</span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">);<br><br></span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">hItem</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">hItem2</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">lParam</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">LPARAM</span><span class="cpp1-symbol">)</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">&amp;</span><span
 class="cpp1-identifier">Tab</span><span class="cpp1-symbol">[</span><span
 class="cpp1-number">1</span><span class="cpp1-symbol">];<br></span><span
 class="cpp1-identifier">TreeView_SetItem</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">hTree</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">&amp;</span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">);<br><br></span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">hItem</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">hItem3</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">lParam</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">LPARAM</span><span class="cpp1-symbol">)</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">&amp;</span><span
 class="cpp1-identifier">Tab</span><span class="cpp1-symbol">[</span><span
 class="cpp1-number">2</span><span class="cpp1-symbol">];<br></span><span
 class="cpp1-identifier">TreeView_SetItem</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">hTree</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">&amp;</span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">);<br><br></span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">hItem</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">hItemChild</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">lParam</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">LPARAM</span><span class="cpp1-symbol">)</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">&amp;</span><span
 class="cpp1-identifier">Tab</span><span class="cpp1-symbol">[</span><span
 class="cpp1-number">3</span><span class="cpp1-symbol">];<br></span><span
 class="cpp1-identifier">TreeView_SetItem</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">hTree</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">&amp;</span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">);<br></span></span>
</code></pre>
<p>
Nasze drzewo od razu nabra³o cywilizowanego wygl¹du :-).
</p>
<h2>
Dynamiczne ikonki
</h2>
<p>
Drzewo od razu nabra³o cywilizowanego wygl¹du, ale wci¹¿ jesteœmy
daleko od idea³u. Ustawiliœmy mianowicie jedn¹ i tê sam¹ ikonkê
wszystkim elementom. Moglibyœmy wprawdzie ustawiæ ró¿ne indeksy dla<code>
iImage</code> oraz <code>iSelectedImage</code>, ale efekt
niekoniecznie by³by taki, jak oczekujemy. Przyzwyczailiœmy siê bowiem,
¿e ikonka elementu zmienia siê wtedy, gdy ten zostanie rozwiniêty,
podczas gdy<code> iSelectedImage</code> zwi¹zana jest z zaznaczeniem
elementu (a wiêc ikona zmienia³aby siê po samym klikniêciu na element).
</p>
<p>
Rozwi¹zaniem jest dynamiczne przypisywanie indeksu ikonce. Aby
skorzystaæ z tej cechy, zamiast indeksu obrazka zostawiamy w polach <code>iImage</code>
oraz <code>iSelectedImage</code> wartoœæ <code>I_IMAGECALLBACK</code>.
Od tej pory kontrolka TreeView wysy³a nam powiadomienia <code>TVN_GETDISPINFO</code>,
kiedy tylko potrzebuje pobraæ aktualny indeks obrazka dla elementu.
Powiadomienia te wysy³ane s¹ w formie <code>WM_NOTIFY</code>, a
obs³u¿yæ je mo¿emy nastêpuj¹co:
</p>
<pre><code><span
 style="font-family: Courier New; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10pt; line-height: normal; font-size-adjust: none; font-stretch: normal;"><span
 class="cpp1-reservedword">case</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">WM_NOTIFY</span><span class="cpp1-symbol">:<br>{<br></span><span
 class="cpp1-space"> </span><span class="cpp1-reservedword">if</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">(((</span><span
 class="cpp1-identifier">LPNMHDR</span><span class="cpp1-symbol">)</span><span
 class="cpp1-identifier">lParam</span><span class="cpp1-symbol">)-&gt;</span><span
 class="cpp1-identifier">code</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">==</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TVN_GETDISPINFO</span><span class="cpp1-symbol">)<br></span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">{<br></span><span
 class="cpp1-space">         </span><span class="cpp1-identifier">LPNMTVDISPINFO</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">lptvdi</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">LPNMTVDISPINFO</span><span class="cpp1-symbol">)</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">lParam</span><span
 class="cpp1-symbol">;<br><br></span><span class="cpp1-space">          </span><span
 class="cpp1-identifier">TVITEM</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">item</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">lptvdi</span><span class="cpp1-symbol">-&gt;</span><span
 class="cpp1-identifier">item</span><span class="cpp1-symbol">;<br><br></span><span
 class="cpp1-space">          </span><span class="cpp1-identifier">TVITEM</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-space">          </span><span
 class="cpp1-identifier">tvi</span><span class="cpp1-symbol">.</span><span
 class="cpp1-identifier">mask</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TVIF_HANDLE</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">|</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TVIF_STATE</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">|</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TVIF_CHILDREN</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-space">          </span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">hItem</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">item</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">hItem</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-space">          </span><span
 class="cpp1-identifier">tvi</span><span class="cpp1-symbol">.</span><span
 class="cpp1-identifier">stateMask</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TVIS_EXPANDED</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-space">          </span><span class="cpp1-identifier">TreeView_GetItem</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">hTree</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">&amp;</span><span
 class="cpp1-identifier">tvi</span><span class="cpp1-symbol">);<br></span><span
 class="cpp1-space">          <br>          </span><span
 class="cpp1-reservedword">int</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">nImageIndex</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-space">          </span><span class="cpp1-reservedword">if</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">tvi</span><span class="cpp1-symbol">.</span><span
 class="cpp1-identifier">cChildren</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">==</span><span class="cpp1-space"> </span><span
 class="cpp1-number">0</span><span class="cpp1-symbol">)<br></span><span
 class="cpp1-space">           </span><span class="cpp1-identifier">nImageIndex</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-number">1</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-space">          </span><span
 class="cpp1-reservedword">else<br></span><span class="cpp1-space">              </span><span
 class="cpp1-reservedword">if</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">tvi</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">state</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">&amp;</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">TVIS_EXPANDED</span><span
 class="cpp1-symbol">)<br></span><span class="cpp1-space">                 </span><span
 class="cpp1-identifier">nImageIndex</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-number">4</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-space">              </span><span class="cpp1-reservedword">else<br></span><span
 class="cpp1-space">                 </span><span
 class="cpp1-identifier">nImageIndex</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-number">3</span><span class="cpp1-symbol">;</span><span
 class="cpp1-space">   <br>                    <br>         </span><span
 class="cpp1-identifier">lptvdi</span><span class="cpp1-symbol">-&gt;</span><span
 class="cpp1-identifier">item</span><span class="cpp1-symbol">.</span><span
 class="cpp1-identifier">iImage</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">nImageIndex</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-space">         </span><span class="cpp1-identifier">lptvdi</span><span
 class="cpp1-symbol">-&gt;</span><span class="cpp1-identifier">item</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">iSelectedImage</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">nImageIndex</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">}<br>}<br></span><span class="cpp1-reservedword">break</span><span
 class="cpp1-symbol">;<br></span></span>
</code></pre>
<p>
Struktura typu <code>NMTVDISPINFO</code>, do której wskaŸnik dostajemy
w <code>lParam</code>, zawiera (poza standardowym nag³ówkiem
powiadomieniowym) pole<code> item</code>, które jest zmienn¹ znanego
nam ju¿ doskonale typu <code>TVITEM</code>. Pole<code> item.mask</code>
zawieraæ mo¿e w tym przypadku jedn¹ lub kilka spoœród flag: <code>TVIF_CHILDREN,
TVIF_TEXT, TVIF_IMAGE, TVIF_SELECTEDIMAGE</code>. Nas interesuj¹ dwie
ostatnie. Nie obchodzi nas przy tym, która z nich jest ustawiona, w obu
przypadkach zwrócimy ten sam indeks (dlatego nie sprawdzamy, co zawiera
<code>lptvdi-&gt;mask</code>). Wynik bêdzie zale¿a³ od czego innego,
mianowicie od liczby ewentualnych dzieci danego elementu oraz od jego
stanu (rozwiniêty lub zwiniêty). Informacje te zwykle zawarte s¹ w
strukturze <code>TVITEM</code>, ale tutaj akurat nie mo¿emy skorzystaæ
z tej, do której dotarliœmy przez <code>lParam</code>, poniewa¿ nie
zawiera ona potrzebnej nam informacji o ewentualnych dzieciach. Dlatego
wywo³ujemy jeszcze <code>TreeView_GetItem</code>.
</p>
<p>
Efekt jest ju¿ ca³kiem przyzwoity: elementy, które nie posiadaj¹ dzieci
maj¹ jedn¹ ikonkê, elementy-rodzice drug¹, a jeœli rozwiniemy takiego
rodzica (np. klikaj¹c przycisk '+' przy nim), to jego ikonka zmieni siê
na otwarty folder.
</p>
<h2>
Reakcja na zdarzenia
</h2>
<p>
Oprócz wyœwietlania w drzewie ró¿nych rzeczy prawdopodobnie
chcielibyœmy równie¿ np. wykonaæ jak¹œ akcjê, gdy u¿ytkownik kliknie na
jakimœ elemencie. Mo¿emy wykryæ takie zdarzenie poprzez obs³ugê
powiadomieñ. Drzewo wysy³a zarówno standardowe powiadomienia (np. <code>NM_CLICK,
NM_RCLICK</code>), jak i specyficzne dla siebie (np. <code>TVN_SELCHANGED</code>,
oznaczaj¹ce, ¿e u¿ytkownik zaznaczy³ w³aœnie jakiœ element). Tak wiêc
mo¿emy dodaæ do naszej obs³ugi <code>WM_NOTIFY</code> kolejne
przypadki:
</p>
<pre><code><span
 style="font-family: Courier New; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10pt; line-height: normal; font-size-adjust: none; font-stretch: normal;"><span
 class="cpp1-reservedword">case</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">WM_NOTIFY</span><span class="cpp1-symbol">:<br>{<br></span><span
 class="cpp1-space"> </span><span class="cpp1-reservedword">switch</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">(((</span><span
 class="cpp1-identifier">LPNMHDR</span><span class="cpp1-symbol">)</span><span
 class="cpp1-identifier">lParam</span><span class="cpp1-symbol">)-&gt;</span><span
 class="cpp1-identifier">code</span><span class="cpp1-symbol">)<br></span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">{<br></span><span
 class="cpp1-space">	</span><span class="cpp1-reservedword">case</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">TVN_GETDISPINFO</span><span
 class="cpp1-symbol">:<br></span><span class="cpp1-space">	</span><span
 class="cpp1-symbol">{<br></span><span class="cpp1-space">	 </span><span
 class="cpp1-symbol">...</span><span class="cpp1-space"> </span><span
 class="cpp1-comment">//nie bêdziemy siê powtarzaæ ;-)<br></span><span
 class="cpp1-space">	</span><span class="cpp1-symbol">}<br></span><span
 class="cpp1-space">	</span><span class="cpp1-reservedword">break</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-space">	</span><span
 class="cpp1-reservedword">case</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TVN_SELCHANGED</span><span class="cpp1-symbol">:<br></span><span
 class="cpp1-space">	</span><span class="cpp1-symbol">{<br></span><span
 class="cpp1-space">	 </span><span class="cpp1-identifier">HTREEITEM</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">hCurrentItem</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">TreeView_GetSelection</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">hTree</span><span class="cpp1-symbol">);<br></span><span
 class="cpp1-space">	</span><span class="cpp1-symbol">}<br></span><span
 class="cpp1-space">	</span><span class="cpp1-reservedword">break</span><span
 class="cpp1-symbol">;</span><span class="cpp1-space">	<br>        <br> </span><span
 class="cpp1-symbol">}<br>}<br></span><span class="cpp1-reservedword">break</span><span
 class="cpp1-symbol">;<br></span></span>
</code></pre>
<p>
W tym przypadku pobieramy tylko indeks aktualnie zaznaczonego elementu;
co z nim zrobimy, to ju¿ ma³o istotne :-). Obs³uga takiego
powiadomienia mo¿e siê nam przydaæ np. do wyœwietlenia dodatkowych
informacji o elemencie zaznaczonym prez u¿ytkownika. Tutaj z kolei mo¿e
nam siê przydaæ struktura, do której wskaŸnik mamy w <code>TVITEM::lParam</code>.
</p>
<p>
Czêsto zdarza siê, ¿e chcemy, by po klikniêciu prawym przyciskiem na
elemencie pojawia³o siê menu kontekstowe. Mo¿emy w tym celu obs³u¿yæ <code>NM_RCLICK</code>.
Powiadomienie to nie dostarcza nam niestety informacji o dok³adnym
miejscu klikniêcia, wiêc aby dowiedzieæ siê, na jakim elemencie
u¿ytkownik klikn¹³, korzystamy z makra <code>TreeView_HitTest</code>,
podaj¹c mu jako parametr adres struktury <code>TVHITTESTINFO</code>.
Struktura ta zawiera trzy pola: <code>pt, flags, hItem</code>. Do pola
<code>pt</code> wpisujemy wspó³rzêdne punktu, o którym chcemy siê
dowiedzieæ, jak¹ czêœæ drzewa stanowi - w naszym przypadku chodzi o
wspó³rzêdne kursora myszy, które mo¿emy pobraæ za pomoc¹ <code>GetCursorPos()</code>.
Gdy komunikat wys³any przez makro wróci, pole<code> flags</code> bêdzie
zawiera³o informacjê o tym, nad jak¹ czêœci¹ drzewa znalaz³ siê kursor,
a <code>hItem</code> bêdzie uchwytem do elementu pod kursorem (albo
bêdzie równe <code>NULL</code>, jeœli mysz nie znajduje siê nad ¿adnym
elementem).
</p>
<h2>
Dynamiczny kolor i czcionka
</h2>
<p>
Przydatn¹ cech¹ by³aby zmiana kolorów elementów tudzie¿ niektórych
atrybutów ich czcionki w pewnych sytuacjach. Na przyk³ad moglibyœmy
chcieæ, aby da³o siê "wy³¹czaæ" wybrane elementy (wtedy by³yby
wyœwietlane na szaro), albo wypisywaæ pogrubion¹ czcionk¹ te elementy,
które zawieraj¹ w nazwie podane przez u¿ytkownika s³owo. Na szczêœcie
nie musimy siê uciekaæ do subclassingu, aby tego dokonaæ.
</p>
<p>
Istnieje bowiem specjalne powiadomienie - <code>NM_CUSTOMDRAW</code>.
Parametr <code>lParam</code> tego powiadomienia zawiera wskaŸnik na
pewn¹ strukturê. Jeœli mamy pewnoœæ, ¿e powiadomienie przysz³o od
naszego drzewka, to bêdzie to struktura typu <code>NMTVCUSTOMDRAW</code>.
Zawiera ona sporo ciekawych rzeczy, z których szczególnie ciekawe jest
dla nas w tym momencie pole <code>nmcd.dwDrawStage</code>. Mówi ono, w
którym stadium rysowania elementu siê obecie znajdujemy. Albo innymi
s³owy, jakich informacji ¿¹da od nas kontrolka, która chce siê
narysowaæ (drzewo).
</p>
<p>
I tak jeœli pole to jest równe <code>CDDS_PREPAINT</code>, to oznacza,
¿e drzewo pyta nas, czy chcemy od niego dostawaæ dalsze szczegó³owe
komunikaty "z frontu", czyli na temat rysowania poszczególnych
elementów, a jeœli tak, to jakie. Interesuje nas informacja o
odrysowywaniu elementu, wiêc odpowiadamy wartoœci¹ <code>CDRF_NOTIFYITEMDRAW</code>.
Od tej pory drzewo us³u¿nie powiadamia nas, co i kiedy chce sobie
narysowaæ. Tu¿ przed narysowaniem tego czegoœ dostaniemy powiadomienie,
dla którego <code>dwDrawStage</code> bêdzie równe <code>CDDS_ITEMPREPAINT</code>.
To jest w³aœciwy moment, by podpowiedzieæ drzewku, jakiej czcionki i
koloru powinno u¿yæ do rysowania elementu. Struktura <code>NMTVCUSTOMDRAW</code>
zawiera gdzieœ miêdzy innymi uchwyt do elementu, wiêc mo¿emy go
wykorzystaæ do pobrania informacji o tym elemencie i wybrania w³aœciwej
czcionki/koloru. Konkretnie uchwyt ten jest upychany w polu <code>nmcd.dwItemSpec</code>
(oczywiœcie po odpowiedniej konwersji).
</p>
<p>
Doœæ gadania, zmieñmy ten kolor. Pójdziemy tym razem na ³atwiznê i nie
wykorzystamy wspomnianego uchwytu. Zamiast tego pobawimy siê polem<code>
iLevel</code> struktury <code>NMTVCUSTOMDRAW</code> (pamiêtaj¹c, ¿e
jest ono dostêpne w Common Controls w wersji 4.71 lub nowszej). Oznacza
ono poziom zagnie¿d¿enia elementu (0 - korzeñ, 1 - dziecko korzenia
itd.). Naszym celem niech bêdzie pomalowanie na niebiesko elementów o
poziomie wiêkszym lub równym <code>1</code>.
</p>
<pre><code><span
 style="font-family: Courier New; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10pt; line-height: normal; font-size-adjust: none; font-stretch: normal;"><span
 class="cpp1-reservedword">case</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">WM_NOTIFY</span><span class="cpp1-symbol">:<br>{<br></span><span
 class="cpp1-space"> </span><span class="cpp1-reservedword">switch</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">(((</span><span
 class="cpp1-identifier">LPNMHDR</span><span class="cpp1-symbol">)</span><span
 class="cpp1-identifier">lParam</span><span class="cpp1-symbol">)-&gt;</span><span
 class="cpp1-identifier">code</span><span class="cpp1-symbol">)<br></span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">{<br></span><span
 class="cpp1-space">	</span><span class="cpp1-reservedword">case</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">TVN_GETDISPINFO</span><span
 class="cpp1-symbol">:<br></span><span class="cpp1-space">	</span><span
 class="cpp1-symbol">{<br></span><span class="cpp1-space">	 </span><span
 class="cpp1-symbol">...</span><span class="cpp1-space"> </span><span
 class="cpp1-comment">//nie bêdziemy siê powtarzaæ ;-)<br></span><span
 class="cpp1-space">	</span><span class="cpp1-symbol">}<br></span><span
 class="cpp1-space">	</span><span class="cpp1-reservedword">break</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-space">	</span><span
 class="cpp1-reservedword">case</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TVN_SELCHANGED</span><span class="cpp1-symbol">:<br></span><span
 class="cpp1-space">	</span><span class="cpp1-symbol">{<br></span><span
 class="cpp1-space">	</span><span class="cpp1-symbol">...</span><span
 class="cpp1-space"> </span><span class="cpp1-comment">//nie bêdziemy siê powtarzaæ ;-)<br></span><span
 class="cpp1-space">	</span><span class="cpp1-symbol">}<br></span><span
 class="cpp1-space">	</span><span class="cpp1-reservedword">break</span><span
 class="cpp1-symbol">;</span><span class="cpp1-space">	<br>	</span><span
 class="cpp1-reservedword">case</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">NM_RCLICK</span><span class="cpp1-symbol">:<br></span><span
 class="cpp1-space">	</span><span class="cpp1-symbol">{<br></span><span
 class="cpp1-space">	</span><span class="cpp1-symbol">}<br></span><span
 class="cpp1-space">	</span><span class="cpp1-reservedword">break</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-space">	</span><span
 class="cpp1-reservedword">case</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">NM_CUSTOMDRAW</span><span class="cpp1-symbol">:<br></span><span
 class="cpp1-space">        </span><span class="cpp1-symbol">{<br></span><span
 class="cpp1-space">           </span><span class="cpp1-identifier">LPNMTVCUSTOMDRAW</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">lpNMCustomDraw</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">LPNMTVCUSTOMDRAW</span><span
 class="cpp1-symbol">)</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">lParam</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-space">           </span><span class="cpp1-reservedword">switch</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">lpNMCustomDraw</span><span class="cpp1-symbol">-&gt;</span><span
 class="cpp1-identifier">nmcd</span><span class="cpp1-symbol">.</span><span
 class="cpp1-identifier">dwDrawStage</span><span class="cpp1-symbol">)<br></span><span
 class="cpp1-space">           </span><span class="cpp1-symbol">{<br></span><span
 class="cpp1-space">            </span><span class="cpp1-reservedword">case</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">CDDS_PREPAINT</span><span
 class="cpp1-symbol">:<br></span><span class="cpp1-space">             </span><span
 class="cpp1-reservedword">return</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">CDRF_NOTIFYITEMDRAW</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-space">            </span><span
 class="cpp1-reservedword">case</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">CDDS_ITEMPREPAINT</span><span
 class="cpp1-symbol">:<br></span><span class="cpp1-space">            </span><span
 class="cpp1-symbol">{<br></span><span class="cpp1-space">             </span><span
 class="cpp1-reservedword">if</span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">lpNMCustomDraw</span><span class="cpp1-symbol">-&gt;</span><span
 class="cpp1-identifier">iLevel</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">==</span><span class="cpp1-space"> </span><span
 class="cpp1-number">1</span><span class="cpp1-symbol">)<br></span><span
 class="cpp1-space">              </span><span class="cpp1-identifier">lpNMCustomDraw</span><span
 class="cpp1-symbol">-&gt;</span><span class="cpp1-identifier">clrText</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">RGB</span><span
 class="cpp1-symbol">(</span><span class="cpp1-number">0</span><span
 class="cpp1-symbol">,</span><span class="cpp1-number">0</span><span
 class="cpp1-symbol">,</span><span class="cpp1-number">255</span><span
 class="cpp1-symbol">);<br></span><span class="cpp1-space">             </span><span
 class="cpp1-reservedword">else</span><span class="cpp1-space"> <br>              </span><span
 class="cpp1-reservedword">return</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">CDRF_DODEFAULT</span><span class="cpp1-symbol">;</span><span
 class="cpp1-space"> <br>             </span><span
 class="cpp1-reservedword">return</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">CDRF_NEWFONT</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-space">             </span><span class="cpp1-symbol">}<br></span><span
 class="cpp1-space">           </span><span class="cpp1-symbol">}</span><span
 class="cpp1-space">           <br>        </span><span
 class="cpp1-symbol">}</span><span class="cpp1-space">   <br>        </span><span
 class="cpp1-reservedword">break</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">}<br>}<br></span><span
 class="cpp1-reservedword">break</span><span class="cpp1-symbol">;<br></span></span>
</code></pre>
<p>
Zmiany koloru tekstu (w podobny sposób mo¿emy równie¿ zmieniæ kolor
t³a) dokonujemy przez wpisanie ¿¹danej wartoœci w pole <code>clrText</code>
omawianej struktury. Gdybyœmy chcieli do tego zmieniæ czcionkê, mo¿emy
przypisaæ j¹ do <code>hdc</code> "wyci¹gniêtego" ze struktury <code>nmcd</code>.
Bez wzglêdu na to, co zmieniamy w wyœwietlanym tekœcie, musimy zwróciæ <code>CDRF_NEWFONT</code>.
Jeœli nie zmieniamy nic (tak, jak w powy¿szym przyk³adzie dla elementów
poziomu ró¿nego od 1), to zwracamy <code>CDRF_DODEFAULT</code>.
</p>
<p align=center><img src="..\gfx\treeview2.gif" alt="Drzewo z niebieskimi liœciami... Sen wariata? Niekoniecznie."></p>
<p>
Zwrócenie odpowiedniej wartoœci jest tutaj spraw¹ ¿ycia i œmierci
niemal¿e, wiêc pojawi siê problem, gdy nasze drzewo umieszczone jest w
oknie dialogowym posiadaj¹cym w³asn¹ procedurê okienkow¹. Jak wiemy,
procedura taka mo¿e zwracaæ jedynie <code>TRUE</code> lub <code>FALSE</code>.
Dlatego warto poznaæ sposób, który s³u¿y do obejœcia tego ograniczenia.
Istnieje pewien atrybut okna dialogowego, który mo¿emy ustawiæ za
pomoc¹ <code>SetWindowLong</code> (a w³aœciwie <code>SetWindowLongPtr</code>,
gdybyœmy chcieli zachowaæ zgodnoœæ z najnowszymi trendami ;-P).
Wartoœæ, któr¹ chcemy zwróciæ, umieszczamy w³aœnie w tym atrybucie:
</p>
<pre><code><span
 style="font-family: Courier New; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10pt; line-height: normal; font-size-adjust: none; font-stretch: normal;"><span
 class="cpp1-identifier">SetWindowLongPtr</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">hwndDialog</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">DWLP_MSGRESULT</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">LONG</span><span class="cpp1-symbol">)</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">CDRF_NEWFONT</span><span
 class="cpp1-symbol">);<br></span></span>
</code></pre>
<p>
...po czym spokojnie zwracamy <code>TRUE</code>. System po otrzymaniu
naszego <code>TRUE</code> sprawdzi najpierw wartoœæ, przechowywan¹ w
atrybucie <code>DWLP_MSGRESULT</code>. Jeœli komunikat, na który
odpowiadamy, wymaga³ zwrócenia jakiejœ wartoœci, to zostanie u¿yta ta z
atrybutu <code>DWLP_MSGRESULT</code>. W ten sposób mamy pe³n¹ obs³ugê <code>NM_CUSTOMDRAW</code>
tak¿e i w dialogu.
</p>
<h2>
Lista CheckBox-ów
</h2>
<p>
Kontrolka TreeView posiada jeszcze jedn¹ ciekaw¹ cechê. Mo¿emy
wyœwietlaæ CheckBox-y obok elementów (dok³adniej: miêdzy ikonk¹, a
tekstem). Wystarczy do³¹czyæ styl <code>TVS_CHECKBOXES</code> przy
tworzeniu drzewa:
</p>
<pre><code><span
 style="font-family: Courier New; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10pt; line-height: normal; font-size-adjust: none; font-stretch: normal;"><span
 class="cpp1-identifier">HWND</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">hTree</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">CreateWindowEx</span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">WS_EX_CLIENTEDGE</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">WC_TREEVIEW</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-string">"Drzefko"</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">WS_CHILD</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">|</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">WS_VISIBLE</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">|</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">WS_BORDER<br></span><span class="cpp1-space">    </span><span
 class="cpp1-symbol">|</span> </span><span
 class="cpp1-identifier">TVS_HASBUTTONS</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">|</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TVS_HASLINES</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">|</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TVS_LINESATROOT</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">|</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TVS_CHECKBOXES</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-number">5</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-number">5</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-number">300</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-number">450</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">g_hwnd</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">HMENU</span><span
 class="cpp1-symbol">)</span><span class="cpp1-number">1001</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">hThisInstance</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">NULL</span><span
 class="cpp1-symbol">);<br></span></span>
</code></pre>
<p align=center><img src="..\gfx\treeview3.gif" alt="Takie rzeczy te¿ mog¹ wyrosn¹æ na drzewie."></p>
<p>
Oczywiœcie nic nie stoi na przeszkodzie, aby schowaæ ikonki, linie i
przyciski "+", "-". Wszystko wedle indywidualnych potrzeb. Bez wzglêdu
na to musimy jednak mieæ jakiœ sposób na ustawienie i odczytanie stanu
ka¿dego CheckBox-a (zaznaczony lub nie). Dokumentacja do Platform SDK
zaleca napisanie sobie takiej oto funkcji:
</p>
<pre><code><span
 style="font-family: Courier New; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10pt; line-height: normal; font-size-adjust: none; font-stretch: normal;"><span
 class="cpp1-identifier">BOOL</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TreeView_SetCheckState</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">HWND</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">hwndTreeView</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">HTREEITEM</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">hItem</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">BOOL</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">fCheck</span><span
 class="cpp1-symbol">)<br>{<br></span><span class="cpp1-space">    </span><span
 class="cpp1-identifier">TVITEM</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">tvItem</span><span class="cpp1-symbol">;<br><br></span><span
 class="cpp1-space">    </span><span class="cpp1-identifier">tvItem</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">mask</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">TVIF_HANDLE</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">|</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">TVIF_STATE</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-space">    </span><span
 class="cpp1-identifier">tvItem</span><span class="cpp1-symbol">.</span><span
 class="cpp1-identifier">hItem</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">hItem</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-space">    </span><span class="cpp1-identifier">tvItem</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">stateMask</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">TVIS_STATEIMAGEMASK</span><span
 class="cpp1-symbol">;<br><br></span><span class="cpp1-space">    </span><span
 class="cpp1-identifier">tvItem</span><span class="cpp1-symbol">.</span><span
 class="cpp1-identifier">state</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">INDEXTOSTATEIMAGEMASK</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">((</span><span
 class="cpp1-identifier">fCheck</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">?</span><span class="cpp1-space"> </span><span
 class="cpp1-number">2</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">:</span><span class="cpp1-space"> </span><span
 class="cpp1-number">1</span><span class="cpp1-symbol">));<br><br></span><span
 class="cpp1-space">    </span><span class="cpp1-reservedword">return</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">TreeView_SetItem</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">(</span><span
 class="cpp1-identifier">hwndTreeView</span><span class="cpp1-symbol">,</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">&amp;</span><span
 class="cpp1-identifier">tvItem</span><span class="cpp1-symbol">);<br>}<br></span></span>
</code></pre>
<p>
S³u¿y ona oczywiœcie do zmiany stanu zaznaczenia podanego elementu. Aby
zaœ sprawdziæ, w jakim aktualnie jest on stanie, mo¿emy napisaæ
funkcjê:
</p>
<pre><code><span
 style="font-family: Courier New; font-style: normal; font-variant: normal; font-weight: normal; font-size: 10pt; line-height: normal; font-size-adjust: none; font-stretch: normal;"><span
 class="cpp1-identifier">BOOL</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TreeView_GetCheckState</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">HWND</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">hwndTreeView</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">HTREEITEM</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">hItem</span><span class="cpp1-symbol">)<br>{<br></span><span
 class="cpp1-space">    </span><span class="cpp1-identifier">TVITEM</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">tvItem</span><span
 class="cpp1-symbol">;<br><br></span><span class="cpp1-space">    </span><span
 class="cpp1-identifier">tvItem</span><span class="cpp1-symbol">.</span><span
 class="cpp1-identifier">mask</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TVIF_HANDLE</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">|</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TVIF_STATE</span><span class="cpp1-symbol">;<br></span><span
 class="cpp1-space">    </span><span class="cpp1-identifier">tvItem</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">hItem</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">=</span><span
 class="cpp1-space"> </span><span class="cpp1-identifier">hItem</span><span
 class="cpp1-symbol">;<br></span><span class="cpp1-space">    </span><span
 class="cpp1-identifier">tvItem</span><span class="cpp1-symbol">.</span><span
 class="cpp1-identifier">stateMask</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">=</span><span class="cpp1-space"> </span><span
 class="cpp1-identifier">TVIS_STATEIMAGEMASK</span><span
 class="cpp1-symbol">;<br><br></span><span class="cpp1-space">    </span><span
 class="cpp1-identifier">TreeView_GetItem</span><span
 class="cpp1-symbol">(</span><span class="cpp1-identifier">hwndTreeView</span><span
 class="cpp1-symbol">,</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">&amp;</span><span class="cpp1-identifier">tvItem</span><span
 class="cpp1-symbol">);<br><br></span><span class="cpp1-space">    </span><span
 class="cpp1-reservedword">return</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">((</span><span class="cpp1-identifier">BOOL</span><span
 class="cpp1-symbol">)(</span><span class="cpp1-identifier">tvItem</span><span
 class="cpp1-symbol">.</span><span class="cpp1-identifier">state</span><span
 class="cpp1-space"> </span><span class="cpp1-symbol">&gt;&gt;</span><span
 class="cpp1-space"> </span><span class="cpp1-number">12</span><span
 class="cpp1-symbol">)</span><span class="cpp1-space"> </span><span
 class="cpp1-symbol">-</span><span class="cpp1-number">1</span><span
 class="cpp1-symbol">);<br>}<br></span></span>
</code></pre>
<p>
Teraz obs³uga CheckBox-ów na drzewie bêdzie dok³adnie tak prosta, jak
byæ powinna. Nawiasem mówi¹c mi³o, ¿e panowie z MS podpowiadaj¹ nam,
jak stworzyæ te funkcje, jednak z pewnoœci¹ jeszcze milej by by³o,
gdyby je po prostu do³¹czyli do API. Widocznie nie mo¿na mieæ
wszystkiego.
</p>
<p>
¯eby nie zakoñczyæ odcinka narzekaniem, podsumujmy nasze osi¹gniêcia
:-). Dowiedzieliœmy siê, jak stworzyæ kontrolkê TreeView i dodawaæ do
niego elementy o dowolnej hierarchii. Nauczyliœmy siê ustawiaæ ikonki
elementów i wyci¹gaæ z systemu standardowe ikony. Nastêpnie
sparawiliœmy, ¿e drzewo zaczê³o reagowaæ na poczynania u¿ytkownika.
Upiêkszyliœmy je trochê, dorzucaj¹c trochê kolorów do standardowej,
pogrzebowej czerni, a wreszcie wzbogaciliœmy ca³oœæ o przydatne
CheckBox-y. Oczywiœcie jest to tylko czêœæ funkcjonalnoœci, któr¹
oferuje nam drzewo. Mo¿na by jeszcze pogadaæ o edycji etykiet,
wyœwietlaniu podpowiedzi, hot-trackingu i paru innych bajerach, ale
coby wtedy zosta³o dla czytelników do samodzielnych eksperymentów? ;-)
</p>
<hr color="GRAY" width="90%" size="1">
<table align="center">
  <tbody>
    <tr>
      <td class="TDN">
      <a href="apitool3.html">&lt;&lt; Toolbary, cz.3</a> &nbsp;
      <a href="../winapi.html">Spis</a> &nbsp;
      <a href="../index.html" target="_top">Strona g³ówna</a> &nbsp;
      <a href="apitray.html">Tray &gt;&gt;</a> &nbsp;
      </td>
    </tr>
  </tbody>
</table>
</body>
</html>
