<html><head>


<meta http-equiv="content-type" content="text/html; charset=iso-8859-2"><title>Postfix - podstawy konfiguracji</title></head><body><center><table border="0" cellpadding="0" cellspacing="0" width="760">

  <tbody><tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
    <br><br><center>
    <b>Postfix - podstawy konfiguracji</b><br>
    wersja 2.60<br>&nbsp;
  </center></font></td></tr>

<tr><td><br></td></tr>
<tr><td bgcolor="blue"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<b>Spis tre¶ci</b><br></font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
<a href="#zmiany">ChangeLog</a><br>
<a href="#czymjest">1. Czym jest Postfix ?</a><br>
<a href="#instalka">2. O instalacji</a><br><br>
<a href="#rzutoka">3. Rzut oka na pliki konfiguracyjne.</a><br>
<a href="#polecenia">4. Podstawowe polecenia.</a><br>
<a href="#pierwszyraz">5. Mój pierwszy raz.</a><br>
<a href="#modem">6. A co gdy mam modem ?</a><br><br>
<a href="#wysylanie">7. Zmiana adresu nadawcy przy wysy³aniu poczty.</a><br>
<a href="#aliasy">8. Adresy poczty przychodz±cej.</a><br>
<a href="#zabraknie">9. Gdy kogo¶ zabraknie.</a><br>
<a href="#usuwanie">10. Usuwanie listu z kolejki.</a><br><br>
<a href="#restrykcje">11. Restrykcje (na podstawie:)</a><br>
&nbsp;&nbsp;&nbsp;<a href="#res_ip">a. Adresu IP komputera wysy³aj±cego</a><br>
&nbsp;&nbsp;&nbsp;<a href="#res_nadawca">b. Adresu e-mailowego nadwacy</a><br>
&nbsp;&nbsp;&nbsp;<a href="#res_odbiorca">c. Adresu e-mailowego odbiorcy</a><br><br>
<a href="#virtual">12. Wirtualne domeny</a><br>
&nbsp;&nbsp;&nbsp;<a href="#virtual_postfix">a. w stylu postfixa</a><br>
&nbsp;&nbsp;&nbsp;<a href="#virtual_sendmail">b. w stylu sendmaila</a><br>
<br>
<a href="#sms">13. Powiadamianie na komórkê (Plus GSM)</a><br>
<a href="#gg">14. Powiadamianie na GaduGadu</a><br>
<a href="#mks">15. Postfix + MKS vir</a><br>
<a href="#stat">16. Statystyki 4 Postfix.</a><br>
<a href="#error">17. Oczekuj±c na b³±d</a><br>
<a href="#jaki">18. Jaki serwer ?</a><br>
<a href="#inne">19. Inne.</a><br>
<a href="#tls">20. Postfix + TLS.</a><br>
<a href="#poslo">Pos³owie</a><br>
<br><br>
</font></td></tr>

<tr><td bgcolor="blue"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="zmiany">ChangeLog</a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Zmiany od wersji 1.1 tego dokumentu:<br>
- poprawiono kilka b³êdów rzeczowych, dopisano kilka<br>
ciekawych spraw, ca³kowicie zmieniono (i rozbudowano) restrykcje.<br>
Zmiany od wersji 1.9a:<br>
- dodano statystyki. <br>
Zmiany od wersji 2.0:<br>
- dodano opis obs³ugi virtualnych domen. <br>
Zmiany od wersji 2.1:<br>
- powiadamianie na komórê o poczcie (SMS na Plus GSM)<br>
Zmiany od wersji 2.2:<br>
- program antywirusowy<br>
Zmiany od wersji 2.3:<br>
- dopisano kilka ciekawych rzeczy do "innych", dodano <br>
"oczkuj±c na b³±d" oraz "jaki serwer ?"<br>
Zmiany od wersji 2.4:<br>
- nie by³o takiej wersji :)<br>
Zmiany od wersji 2.5:<br>
- powiadamianie na GG o nowej poczcie, drobiazgi w ostatnim punkcie<br>
Zmiany od wersji 2.6:<br>
- postfix + TLS
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="czymjest">1. Czym jest Postfix ?</a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Je¶li u¿ywasz Linuxa, prawdopodobnie serwerem poczty na <br>
twoim komputerze jest program Sendmail. Co o nim wiemy ?<br><br>
* zyska³ sobie s³awê jako najbardziej dziurawy program <br>
unixowy. Istniej± dziesi±tki sposobów, przez które mo¿na (by³o)<br>
"namieszaæ" w systemie dziêki temu progsowi.<br><br>
* jest trudny w konfiguracji. Je¶li kiedykolwiek próbowa³e¶ to <br>
robiæ, wiesz o co chodzi. Je¶li nie, nie bêdziesz mia³ okazji - po<br>
przesiadce na Postfixa :)<br><br>
To by³o przypomnienie, powróæmy do Postfixa. Jest to serwer poczty,<br>
pozbawiony wad Sendmaila. Zosta³ od pocz±tku<br>
pisany jako progam maj±cy byæ szybki, bezpieczny i ³atwy w administracji.<br>
Jakby nie patrzeæ, Postfix bardzo szybko zdobywa popularno¶æ i nic nie<br>
wskazuje na to, ¿e to siê zmieni. Chyba ju¿ czas przesi±¶æ siê na <br>
Postfixa. Jedziemy!
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="instalka">2. O instalacji</a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Program mo¿na pobraæ spod adresu <a href="http://www.postfix.org/"><br>
www.postfix.org</a>. Znajduje siê tam tak¿e dokumentacja, FAQ itp.<br>
Instalacja nie powinna stwarzaæ ¿adnych problemów. Je¶li co¶ pójdzie <br>
nie tak, szukamy pomocy w dokumentacji. <br><br>

Ja zak³adam, ¿e wszystko zosta³o
pomy¶lnie zainstalowane. Wspomnê tylko o tym, <br>¿e bêdziemy musieli dodaæ
do naszego systemu nowego u¿ytkownika "postfix"<br> i grupê "postdrop".
Tak jest przynajmniej w
Slacku, nie wiem, <br>czy w RedHacie automatycznie go doda. Tak czy inaczej<br>
nale¿y czytaæ dokumentacjê. Nastêpnie pozbywamy siê Sendmaila. <br><br>
Proponujê siê nie wahaæ i zrobiæ <br>
to tak, jak sugeruje dokumentacja Postfixa:<br><br>
- je¶li ³±czymy siê z Inetem przez modem, i mamy skolejkowan±, jeszcze<br>
nie wys³an± pocztê (mailq), ³±czymy siê z Sieci± i wysy³amy zaleg³±<br>
pocztê (sendmail -q).<br><br>
- je¶li sendmail jest uruchomiony (ps x) musimy go
zamkn±æ. Raz na zawsze :)<br> Ja go po prostu kill'n±³em, choæ prawdopodobnie
istnieje na to jaki¶ bardziej<br> cywilizowany sposób.<br><br>
- teraz szukamy pliki sendmaila (`which sendmail`), zmieniamy ich nazwê<br>
poprzez polecenie `mv sendmail sendmail.OFF` a nastêpnie zabieramy prawa<br>
(m.in. suida) temu plikowi: `chmod 700 sendmail.OFF`.<br><br>
- usuwamy wywo³anie Sendmaila ze skryptów startowych. Chodzi o katalog<br>
/etc/rc.d/ w przypadku Slacka, je¶li RedHat, to chyba gdzie¶ w <br>
/etc/rc.d/init.d. W którym¶ z plików rc.X znajdujemy wywo³anie sendmaila,<br>
usuwamy je, lub wstawiamy # (hash) przed linijkê z wywo³aniem. W to <br>
miejsce mo¿emy od razu wpisaæ `postfix start`.<br><br>
- je¶li nasz klient poczty tego wymaga, odpowiednio go ustawiamy.<br>
W przypadku Pine, który domy¶lnie sam wywo³uje sendmaila, wchodzimy<br>
do: Setup--&gt;Config a nastêpnie w pole "smtp-server"wpisujemy
<i>localhost.</i><br> Oczywi¶cie je¶li to nasz komp ma byæ serwkiem poczty.
Nie wiem, jak jest<br> w przypadku innych klientów poczty, ale pewnie
podobnie.<br> Dobra, to chyba tyle. Od tego miejsca zak³adam, ¿e sendmail nie
jest <br> uruchomiony, oraz ¿e postfix zosta³ poprawnie zainstalowany.
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="rzutoka">3. Rzut oka na pliki konfiguracyjne</a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Pliki konfiguracyjne programu Postfix
umieszczone s± w katalogu<br> <b>/etc/postfix</b>. Rzuæ tam okiem.
Najwa¿niejszym plikiem jest<br> <b>main.cf</b>. Znajduj± siê w nim wszystkie
najwa¿niejsze opcje<br> dzia³ania programu postfix. Je¶li siê mu przyjrzysz,
stwierdzisz, <br> ¿e s± one dobrze opisane, co u³atwi Tobie ju¿ nied³ugo
zmianê <br> jego parametrów. <br><br>Kolejnymi plikami, o których warto wspomnieæ,<br>
s± pliki <b>sample-.....</b>. Zawieraj± one wskazówki o tym, jak<br>
zmieniaæ poszczególne opcje dzia³ania postfixa. Pliki te oka¿± siê<br>
bardzo przydatnymi, je¶li bêdziesz wprowadza³ jakiekolwiek zmiany.<br><br>
Innymi wa¿nymi plikami s± pliki o pewnej nazwie, bez rozszerzenia, oraz<br>
odpowiadaj±ce im pliki o tej samej nazwie z rozszerzeniem .db.<br>
Przyk³ad: aliases oraz aliases.db. To m.in. dziêki nim konfiguracja<br>
naszego serwera poczty jest taka prosta.
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="polecenia">4. Podstawowe polecenia</a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Do wywo³ywania poni¿szych poleceñ potrzebne s±, o ile siê nie mylê,<br>
uprawnienia root'a. Co mo¿emy zrobiæ z serwerem poczty ?<br><br>
* mo¿emy go uruchomiæ: <b>postfix start</b><br>
* mo¿emy go tak¿e zatrzymaæ: <b>postfix stop</b><br>
* mo¿emy go "zrestartowaæ": <b>postfix reload</b><br><br>
Nie wiem dlaczego, to ostatnie kojarzy mi siê z M$ Windows... <br>
Jeszcze nic nie uruchamiaj, poczekaj do nastêpnego punktu.<br>
Ta trzecia mo¿liwo¶æ jest przydatna, gdy zmienimy pliki konfiguracyjne<br>
programu. Nie musimy wtedy postfixa zatrzymywaæ i uruchamiaæ od nowa,<br>
co daje w sumie 2 komendy :) Wystarczy wywo³aæ "reload", aby program <br>
zrestartowa³ siê, wczytuj±c nowe ustawienia.<br><br>
Pamiêtajmy, ¿e po ka¿dej zmianie w plikach konfiguracyjnych, nale¿y<br>
program prze³adowaæ (to jeszcze jedna nazwa na restart).<br>
Teraz o przydatnym poleceniu <b>postconf</b>. Pozwala ono zobaczyæ<br>
warto¶ci poszczególnych parametrów, zmiennych, zmiennych konfiguracyjnych,<br>
jak zwa³, tak zwa³. Dla przyk³adu wywo³aj np. `postconf myhostname`.<br>
Narzêdzie to przydaje siê, gdy szukamy dziury w ca³ym - nie bardzo<br>
wiemy dlaczego co¶ nie dzia³a i szukamy jakiego¶ punktu zaczepienia,<br>
jakiej¶ wskazówki lub gdy sprawdzamy jakie warto¶ci maj± poszczególne<br>
zmienne programu.
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="pierwszyraz">5. Mój pierwszy raz</a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Je¶li postêpowa³e¶ zgodnie z punktem 2, nic nie stoi na przeszkodzie<br>
aby sprawdziæ nowy serwer poczty. Jako root musimy najpierw zmodyfikowaæ<br>
trochê plik /etc/postfix/main.cf. Otwieramy go w ulubionym edytorze, np.<br>
vi, pico, co kto lubi. Musimy teraz poinformowaæ program:<br><br>
* jak nazywa siê nasz komputer:<br>
szukamy linijki o tere¶ci: <i>myhostname = host.domain.name</i> i zmieniamy<br>
'host.domain.name' na nazwê naszego komputera. Gdy nasz komp nazywa siê<br>
np. polska.pl pozostawiamy wpis:<i>myhostname = polska.pl</i>.<br><br>
* zmienna <i>mydestination = </i>. Prawdopodobnie najlepsz± warto¶ci± bêdzie tu <br>
<i>mydestination = $myhostname</i> dlatego je¶li jest inaczej, zmieniamy j±.<br><br>
* je¶li chcemy logowaæ adresy IP komputerów wysy³aj±cych pocztê, a nie ich nazwy:
<br> <i>disable_dns_lookups = </i> na <i>disable_dns_lookups =
yes </i>.<br><br> Je¶li dana zmienna nie istnieje, stwórzmy j± i nadajmy
powy¿sz±         warto¶æ.<br> Plik ten jest dobrze opisany, wiêc czytajmy przy
okazji komentarze.<br> Uwa¿ajmy, zby nie zrobiæ "literówki", wpisujmy
dok³adnie waro¶ci.<br> Je¶li nie jeste¶my pewni, co do nazwy jakiej¶
zmiennej, <br> u¿yjmy polecenia 'postconf |more' aby zobaczyæ mo¿liwe
nazwy<br> zmiennych. Dobra, zapisujemy zmiany. Mo¿emy teraz odpaliæ
postfixa.<br> Jako root (superu¿ytkownik) wpisujemy<br> polecenie '<b>postfix
start</b>'. Powinno to wygl±daæ tak:<br><br><i> # postfix start<br>
postfix-script: starting the Postfix mail system<br><br></i> Dobra, wszystko
jest ok. Mo¿emy teraz spróbowaæ wys³aæ pocztê do<br> jednego z naszych
<b>lokalnych</b> u¿ytkowników. Je¶li co¶ pójdzie nie tak<br> upewnij siê, ¿e
Twój klient poczty nie potrzebuje zmiany konfiguracji.<br> Je¶li ci±gle co¶
nie dzia³a, przeczytaj jeszcze raz punkt 2, tym razem<br> dok³adnie ;).<br><br>
Je¶li list dotar³ do (przypominam, wa¿ne: lokalnego) odbiorcy, gratulujê,<br>
teraz bêdzie ju¿ z górki.
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="modem">6. A co gdy mam modem ?
</a></font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Je¶li korzystasz z us³ug naszego monopolisty, TP s.a. to masz pecha.<br>
Tak zreszt±, jak ja. Na pocz±tek wyrazy wspó³czucia.<br>
Dobra, bierzemy w obroty /etc/postfix/main.cf. <br><br>
* potrzebujemy zmiennej <i>relayhost = </i>. Je¶li takiej nie ma, tworzymy<br>
j±. Jej warto¶æ wskazuje na komputer, przez który poczta bêdzie wys³ana.<br>
Wpisujemy warto ¶æ jakiego¶ serwera poczty, np. poczta.onet.pl. Uwaga:<br>
nie wszystkie "zewnêtrzne" serwery poczty akceptuj± wysy³anie poczty<br>
przez siebie, dlatego najpierw upewnij siê, ¿e listy wys³ane przez niego<br>
trafiaj± do celu. Ja u¿ywam do tego celu komputera poczta.interia.pl<br>
 i nie narzekam - jak na razie dzia³a bezb³êdnie. W ka¿dym razie:<br>
<i> relayhost = poczta.interia.pl</i><br><br>
* druga rzecz, któr± musimy zrobiæ to wprowadziæ do zmiennej <br>
<i>defer_transports</i> warto¶æ "smtp". Ostatecznie mamy:<br><i>
defer_transports = smtp <br></i><br>
I to wszystko, fajne, co ? Dobra. Pewnie chcia³by¶, aby po <br>
wej¶ciu do Inetu, skolejkowana poczta by³a automatycznie wysy³ana.<br>
W tym celu do pliku /etc/ppp/ip-up (tu on jest w Slacku) wpisujemy<br>
<b>postfix flush</b>. Teraz po ka¿dym po³±czeniu, skolejkowana poczta<br>
bêdzie wys³ana poprzez komputer ze zmiennej "relayhost". Nie zapomnij<br>
prze³adowaæ postfixa (postfix reload). A teraz po³±cz siê z Inetem i <br>
zobacz, czy toto dzia³a. <br><br>Pozostaje jeszcze jedna sprawa:<br>
je¶li wy¶lesz list do kogo¶, w jego polu Od: (From:) bêdzie twój<br>
tutejszy adres nadawcy, np. root@localhost. Jak to zmieniæ ? <br>
Odpowied¼ poni¿ej.
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="wysylanie">7. Zmiana adresu nadawcy przy wysy³aniu poczty</a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Je¶li bawimy siê w listy na lokalnym komputerze, nie ma problemu.<br>
Gdy komputer nazywa siê np. polska.pl to mamy adresy np.<br>
linio@polska.pl, root@polska.pl. W sieci lokalnej szafa gra.<br>
Gorzej, gdy chcemy wys³aæ wiadomo¶æ w ¶wiat. Wówczas w polu<br>
From: bêdzie np. linio@poczta.pl. Jako, ¿e nie mam takiego konta<br>
wypada³oby, ¿eby przy wysy³aniu poczty, postfix automatycznie zmienia³<br>
mój adres nadawcy na inny, taki, jaki posiadam na serwerze terramail.pl<br><br>
Innym zastosowaniem tego, jest mo¿liwo¶æ zmiany loginów lokalnych<br>
u¿ytkowników na ich imiona i nazwiska. Ostatnio sta³o to siê bardzo<br>
popularne. Na przyk³ad hnk@polska.pl wysy³a list, i odbiorca dostaje go<br>
od Henryk.Aktinowski@polska.pl. Dobra, jak to zrobiæ:<br><br>
<b>==&gt;</b> Na pocz±tek bierzemy w obroty /etc/postifx/main.cf. Szukamy zmiennej<br>
<b>sender_canonical_maps = </b>. Je¶li nie ma ona warto¶ci, jest ignorowana<br>
przez hash (#) lub ma inn± warto¶æ ni¿ <b>hash:/etc/postfix/sender_canonical
</b>,<br> nadajemy jej tak± warto¶æ i odhash'owujemy j±. Ostatecznie:<br>
<i> sender_canonical_maps = hash:/etc/postfix/sender_canonical </i>.<br>
Jak mo¿esz siê domy¶laæ, w pliku tym bêd± znajdowaæ siê nasze mapowania<br>
jednych u¿ytkowników w innych (dok³adnie: adresów). Zapisujemy zmianê.<br><br>
<b>==&gt;</b> Je¶li nie istnieje plik /etc/postfix/sender_canonical, tworzymy go.<br>
Je¶li istnieje, na jego koñcu dopisujemy odwzorowywania adresów na inne:<br><br>
<b>a)</b> w przypadku ³±czenia siê przez modem:<br>
linio [tutaj spacja lub tabulator] linio@terramail.pl<br>
czesiek czs@interia.pl<br>
jaca yaca@poczta.onet.pl<br>
Co to znaczy ? Adresy e-mail lokalnych u¿ytkowników o loginach linio,<br>
czesiek, jaca bêd± zmienione odpowiednio na linio@terramail.pl, <br>
czs@interia.pl i yaca@poczta.onet.pl. Tak wiêc spokojnie mo¿na wysy³aæ<br>
pocztê przez nasz komputer, bo nadawca w polu From: listu wychodz±cego<br>
bêdzie odpowiednio zmieniona.<br><br>
<b>b)</b> w przypadku sta³ego po³±czenia z Inetem, gdy nazwa naszego komputera<br>
jest nazw± naszego komputera w Internecie, mo¿emy wykorzystaæ ten fakt<br>
do zamiany adresów e-maili z loginów na np. imiona i nazwiska.<br>
Wówczas w tym pliku wpisujemy np.<br>
linio [tu spacje lub tabulatory] Heniek.Liniowski<br>
czesiek Czeslaw.Penerski<br>
hnk Henryk.Aktinowski<br>
itd. Wówczas w polu From: widoczne bêdzie imiê i nazwisko osoby wysy³aj±cej<br>
list. Dobra.<br><br>
<b>c)</b> Pozosta³o zakutalizowaæ nasz± bazê danych w pliku 'sender_canonical'<br>
i prze³adowanie postfixa. A robi to siê tak:<br>
<b>postmap /etc/postfix/sender_canonical</b><br>
<b>postfix reload</b><br>
Pamiêtajmy, ¿e po ka¿dej zmianie bazy danych, odwzorowañ w pliku <br>
'sender_canonical' nale¿y j± uaktualniæ poleceniem 'postmap'.<br>
Dobra, to wszystko na ten temat. Pozostaje jeszcze jedna sprawa:<br>
je¶li nasz komputer (teraz zak³adam sta³e po³±czenie z Netem),<br>
wysy³a list i zamienia hnk na Heniek.Aktinowski jest fajnie.<br><br>
Ale nie ma on pojêcia, co zrobiæ z listem przychodz±cym do <br>
Heniek.Aktinowski@..... Jak temu zaradziæ ? Patrz: nastêpny punkt.
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="aliasy">8. Adresy poczty przychodz±cej</a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Aliasy znajduj± zastosowanie m.in. wtedy, gdy stosujemy
zmianê adresów<br> poczty wychodz±cej. We¼my dla przyk³adu Henryka. Jego login
hnk jest <br> przy wysy³aniu zamieniony na Henryk.Atkinowski. Je¶li kto¶
odpisze na<br> jego list, trafi on do naszego komputera. Nie mamy jednak
u¿ytkownika<br> o takim loginie. Tu w³a¶nie wkraczaj± aliasy. Ich kolejnym
zastosowaniem<br> mo¿e byæ mo¿liwo¶æ tego, ¿e jedna osoba posiada kilka
aliasów i np. <br> poczta do Heniek.Atkinowski@...., Henryczek@..... itd.
trafiaæ bêdzie do<br> jednej osoby. Jeszcze innym zastosowaniem jest mo¿liwo¶æ
taka, ¿e tworzymy<br> zbiorowy alias dla kilku u¿ytkowników. Przyk³adowo list
adresowany do<br> admini@..... trafi do skrzyniki u¿ytkowników root, linio,
czesiek.<br> Dobra, wystarczy tej teorii. Jak to zrobiæ ?<br><br>
--&gt; domy¶lnym plikiem bêd±cym baz± odwzorowañ aliasów jest plik<br>
<b>/etc/aliases</b>. Wrzuæmy go do naszego edytora i dopiszmy na koñcu:<br>
Henryk.Atkinowski: hnk<br>
Henryczek: hnk<br>
Czesik.Penerski: czesiek<br>
admini: root, linio, czesiek<br>
Chyba ³apiesz, o co chodzi. Oczywi¶cie wpisuj takie aliasy, jakie Ci pasuj±<br>
a nie powy¿sze. Zwrócê jescze tylko uwagê na dwukropek, który wystêpuje<br>
po ka¿dym aliasie. Dobra, zapisujemy zmiany.<br><br>
--&gt; pozosta³o jeszcze uaktualniæ bazê danych aliasów. U¿ywamy do tego <br>
linuxowego polecenia <b>newaliases</b>. Nie pomylcie go z innym poleceniem,<br>
newalias. Dobra. Pozosta³o tylko prze³adowaæ postfixa (postfix reload).<br>
Gdyby¶cie chcieli zmieniæ plik z baz± danych aliasów na inny, nale¿y zmieniæ<br>
w /etc/postfix/main.cf wpis dla zmiennej alias_maps = na inny, oraz <br>
alias_database = ale sami siê w to bawcie je¶li domy¶lne Wam nie<br>
odpowiadaj±.
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="zabraknie">9. Gdy kogo¶ zabraknie</a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
O co chodzi ? Za³ó¿my, ¿e na naszym kompie, przez d³u¿szy czas mia³ konto<br>
jacek. Jego adresem by³ jacek@polska.pl. Nasz komputer (polska.pl) <br>
odbiera³ i wysy³a³ dla niego pocztê. Ale Jacek siê wyprowadzi³ lub <br>
zosta³ wyrzucony. W ka¿dym razie ju¿ go nie ma, ale ludzie ci±gle <br>
pisz± listy do niego na ten adres. Co mo¿emy zrobiæ ?<br><br> Mo¿emy tak
skonfigurowaæ postfixa, ¿eby automatycznie, bo odebraniu poczty<br>
dla jacka, wysy³a³ automatycznie odpowied¼, do nadawcy listu,<br>
¿e jacek juz tu nie ma konta, mo¿emy podaæ tak¿e nowy adres lub<br>
inny kontakt z jackiem, np. jego nr telefonu. W ka¿dym razie <br>
czaisz o co chodzi. A robi siê to tak:<br><br>

--&gt; Wrzucamy do edytora plik /etc/postfix/main.cf (znowu on).<br>
Szukamy zmiennej <b>relocated_maps</b>. Je¶li jej nie ma, jest<br>
ignorowana poprzez hash (#) lub nie ma nadanej wartosæi, <br>
wówczas tworzymy j± i nadajemy warto¶æ <b>hash:/etc/postfix/relocated</b><br>
W sumie wygl±da to tak:<br><i>
relocated_maps = hash:/etc/postfix/relocated<br></i>
Dobra, chyba ju¿ wiesz, ¿e trzeba zapisaæ zmiany i wyj¶æ z edytora.<br><br>

--&gt; Je¶li nie istnieje plik /etc/postfix/relocated, to go tworzymy.<br>
Je¶li istnieje, wrzucamy go do edytora. Sk³adnia jest taka:<br><b>
login "ewentualny komentarz w cudzys³owiu"</b>.<br>
Za³ó¿my, ¿e ju¿ nie ma nieszczêsnego jacka, wówczas wpisujemy tam:<br><i>
jacek "Jacek zmieni³ swój adres na jacek@pcim.pl"<br></i>
Je¶li teraz kto¶ wy¶le e-mail do jacka dostanie on od razu list<br>
zwrotny, ¿e tego usera ju¿ tu nie ma i ¿e "Jacek zmieni³ swój adres na
jacek@pcim.pl" <br>Wprowadzamy tyle osób, ile tylko chcemy, ale ka¿da z nich, a
dok³adnie<br> komentarz, powienien siê zmie¶ciæ w jednej linijce. Gdy
komentarz sk³ada<br> siê z wiêcej ni¿ jednego wyrazu, piszemy go w
cudzys³owiu. <br>  Dobra,zapisujemy zmiany.<br><br>
--&gt; Dalej ju¿ chyba wiesz. Wywo³ujemy <b>postmap /etc/postfix/relocated</b>,<br>
a nastêpnie prze³adowujemy postfixa: <b>postfix reload</b>.<br>
Pobawcie siê w to sami, spróbujcie wys³aæ co¶ do takiej osoby.
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="usuwanie">10. Usuwanie listu z kolejki</a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Oki. Za³ó¿my, ¿e mamy sobie modem (i p³acimy z³odziejskie op³aty dla<br>
monopolisty). Za³ó¿my, ¿e postfix przyj±³ list do kogos@gdzies.pl<br>
oraz go skolejkowa³. List czeka na wys³anie a to odbêdzie siê przy<br>
najbli¿szym po³±czeniu z Inetem. Jednak nadawca tego listu siê <br>
rozmy¶li³/zmieni³ zdanie/wytrze¼wia³ i ju¿ nie chce ¿eby list <br>
zosta³ wys³any. Co mo¿emy zrobiæ ?<br><br>
--&gt; Musimy dowiedzieæ siê numer identyfikacyjny  (ID) skolejkowanego<br>
listu. Robimy to wydaj±c polecenie <b>mailq</b>. Po adresie nadawcy i <br>
odbiorcy poznajemy, który list nale¿y cofn±æ. Do usuniêcia listu z <br>
kolejki, wykorzystujemy ID listu. Wygl±da on mniej - wiêcej tak:<br>
90E8A5647C. Ale tajemnicza nazwa !<br><br>
--&gt; Gdy znamy ID listu, jedyne co musimy zrobiæ to usun±æ pliki o<br>
takiej nazwie z katalogu /var/spool/postfix. W tym celu wchodzimy do<br>
katalogu /var/spool/postfix i wydajemy polecenie:<br><b>
find incoming active deferred -name 90E8A5647C -print |sed 1q|xargs rm
<br></b><br> Wygl±da to na trochê skomplikowane. Jak siê gubisz, znajd¼ ten<br>
plik rêcznie i go usuñ. Tak po prostu. Nie muszê chyba pisaæ, ¿e w miejscu<br>
90E8A.... wpisujesz ID listu, który chcesz usun±æ. Gdy go usuniesz i chcesz<br>
siê upewniæ, ¿e jest usuniêty z kolejki, jeszcze raz wydaj polecenie <br>
`mailq`. Powinno go ju¿ tam nie byæ.
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="restrykcje">11. Restrykcje</a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Teraz przyda³oby siê napisaæ parê rzeczy o restrykcjach. Czego maj± <br>
one dotyczyæ ? Na pewno zdajesz sobie sprawê, ¿e mo¿liwe jest <br>
"anonimowe" wysy³anie e-maili przez serwer pocztowy. Polega to <br>
z grubsza na telnetowniu siê na 25 port serwera i  wpisywaniu <br>
odpowiednich poleceñ. W rezultacie mo¿liwe jest wysy³anie listów <br>
z dowolnym adresem nadawcy. Mo¿liwe jest te¿ wys³anie przez nasz <br>
komputer np. listu z pogró¿kami przez dowolny komputer z sieci.<br>
"Bad boys" nigdy nie ¶pi±. Dobra, wystarczy tego czarnego scenariusza.<br>
Opisa³em tutaj mo¿liwe restrykcje do na³o¿enia oraz ich najczê¶ciej <br>
u¿ywane warto¶ci, opcje.
<br><br>
Opiszê tutaj trzy rodzaje mo¿liwych restrykcji:<br>
 - <a href="#res_ip">na podstawie adresu IP/nazwy kompa ³±cz±cego siê z naszym serwerem</a><br>
 - <a href="#res_nadawca">na podstawie adresu nadawcy listu</a><br>
 - <a href="#res_odbiorca">na podstawie adresu odbiorcy listu</a>
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="res_ip"><u>11a. na podstawie adresu IP/nazwy kompa ³±cz±cego siê z naszym serwerem</u></a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Operujemy oczywi¶cie na pliku <i>main.cf</i>. Do tego typu ograniczenia s³u¿y <br>
zmienna <b>smtpd_client_restrictions</b>. Domy¶lna konfiguracja pozwala na <br>
po³±czenia ka¿demu komputerowi klienckiemu.<br><br>
Mo¿emy wprowadziæ nastêpuj±ce ograniczenia:<br>
* <b>permit_mynetworks</b> - pozwala na po³±czenie siê z naszym serwerem komputerom, <br>
z naszej sieci lokalnej (dok³adnie: komputerom, które pasuj± do zmiennej $mynetworks)<br>
* <b>reject_unknown_client</b> - odrzuca komputer, którego adres IP nie ma wpisu w DNS<br>
* <b>check_client_access <i>maptype:mapname</i></b> - sprawdza IP/nazwê komputera w <br>
 pliku wpisanym jako parametr. Zawiera on dane co zrobiæ z danym komputerem.<br>
 Opisane <a href="#dodatek">na koñcu</a> rozdzia³u.<br>
* <b>permit</b> - pozwól na po³±czenie. Przydatne na koñcu listy ograniczeñ, jako<br>
   zachowanie domy¶lne, gdy poprzednie regu³y nie pasuj±.<br>
* <b>reject</b> - odrzuæ po³±czenie. Przydatne na koñcu listy ograniczeñ, jako<br>
   zachowanie domy¶lne, gdy poprzednie regu³y nie pasuj±.<br><br>
Przyk³ady:<br>
<i>smtpd_client_restrictions = permit_mynetworks, reject</i><br>
pozwala na wysy³anie listów tylko komputerom z naszej sieci lokalnej (o ile<br>
dobrze zdefiniowana jest zmienna $mynetworks). Jest to dobre rozwi±zanie dla<br>
sieci lokalnej, je¶li wiemy na pewno, ¿e tylko z niej bêd± wysy³ane listy.<br><br>
<i>smtpd_client_restrictions = reject_unknown_client, permit</i><br>
pozwala wysy³aæ wszystkim, o ile ich IP maj± wpisy w DNSie. Nie pamiêtam<br>
dok³adnie, ale nie pozwoli chyba wysy³aæ listów z LAN (potrzebny na pocz±tku <br>
permit_mynetworks aby LAN przepu¶ci³). <br><br>
<b>UWAGA:</b> po ka¿dorazowej zmianie ograniczeñ, nale¿y upewniæ siê, sprawdziæ<br>
czy dzia³aj± one w sposób taki, jaki chcemy. Czêsto osi±gniemy zablokowanie nie<br>
tylko nieproszonych go¶ci, ale tak¿e siebie lub nasze komputery z LAN. We¼my pod<br>
uwagê wszystkie mo¿liwo¶ci, jakie mog± siê zdarzyæ, ¿eby nie narobiæ wiêcej szkody,<br>
ni¿ po¿ytku !
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="res_nadawca"><u>11b. na podstawie adresu nadawcy listu</u></a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
W tym przypadku nie jest brany pod uwagê adres IP kompa ³±cz±cego siê z naszym <br>
serwerem. Sprawdzane jest pole "list od" (inaczej -  "from:"). Zmienna, która <br>
jest wykorzystywana w tym przypadku to <b>smtpd_sender_restrictions</b>. Domy¶lna<br>
konfiguracja pozwala wys³aæ list zawieraj±cy jakikolwiek adres nadawcy.<br><br>
Mo¿emy wprowadziæ miêdzy innymi nastêpuj±ce ograniczenia:<br>
* <b>reject_unknown_sender_domain</b> - odrzuca list, je¶li adres nadawcy, dok³adnie<br>
czê¶æ po @ adresu nadawcy, nie ma wpisu w DNS. Czyli np. list próbuje wys³aæ <br>
heniek@skocz.mi.pajacu :)<br>
* <b>reject_non_fqdn_hostname</b> - odrzuca list, je¶li adres nadawcy, dok³adnie czê¶æ<br>
po @ adresu nadawcy nie jest "pe³na" (fully-qualified domain form).<br>
* <b>check_sender_access <i>maptype:mapname</i></b> - przeszukuje plik podany <br>
 jako argument. Zawiera on dane co zrobiæ z tym fantem.<br>
 Opisane <a href="#dodatek">na koñcu</a> rozdzia³u.<br>
* <b>permit</b> - pozwól na wys³anie listu. Przydatne na koñcu listy ograniczeñ, jako<br>
   zachowanie domy¶lne, gdy poprzednie regu³y nie pasuj±.<br>
* <b>reject</b> - odrzuæ list. Przydatne na koñcu listy ograniczeñ, jako<br>
   zachowanie domy¶lne, gdy poprzednie regu³y nie pasuj±.<br><br>
Przyk³ad:<br>
<i>smtpd_sender_restrictions = reject_unknown_sender_domain, reject_non_fqdn_hostname</i><br>
Zalecana warto¶æ tego parametru, odrzuca "debilne" adresy nadawcy i jego listy.<br><br>
<b>UWAGA:</b> po ka¿dorazowej zmianie ograniczeñ, nale¿y upewniæ siê, sprawdziæ<br>
czy dzia³aj± one w sposób taki, jaki chcemy. Czêsto osi±gniemy zablokowanie nie<br>
tylko nieproszonych go¶ci, ale tak¿e siebie lub nasze komputery z LAN. Uwa¿aj, ¿eby <br>
nie przesadziæ.
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="res_odbiorca"><u>11c. na podstawie adresu odbiorcy listu</u></a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Tym razem kryterium pozwoliæ - odrzuciæ jest adres odbiorcy listu, adres <br>
docelowy listu.Zmienna, która jest wykorzystywana w tym przypadku to <br>
<b>smtpd_recipient_restrictions</b>. Domy¶lnie na³o¿one s± pewne ograniczenia, <br>
podane w przyk³adach poni¿ej.<br><br>
Mo¿emy wprowadziæ miêdzy innymi nastêpuj±ce ograniczenia:<br>
* <b>reject_non_fqdn_recipient</b> - odrzuæ list, je¶li podany adres odbiorcy <br>
nie jest "pe³ny" (fully-qualified domain form)<br>
* <b>reject_unknown_recipient_domain</b> - odrzuæ, je¶li adres docelowy listu,<br>
jego adres nie istnieje w DNS (czyli i tak nie ma dok±d go wys³aæ) <br>
* <b>check_recipient_access <i>maptype:mapname</i></b> - przeszukuje plik podany <br>
 jako argument i na jego podstawie decyduje czy wys³aæ list.<br>
 Opisane <a href="#dodatek">na koñcu</a> rozdzia³u.<br>
* <b>permit_auth_destination</b> - przyjmij list, je¶li to nasz serwer jest<br>
 jego celem lub adres przeznaczenia zawiera siê w zmiennej $relay_domains.<br>
 Je¶li warunek nie jest spe³niony, bierz pod uwagê nastêpne ograniczenia.<br>
* <b>reject_unauth_destination</b> - podobne do poprzedniego, ale odrzuæ list,<br>
je¶li to nasz serwer nie jest jego przeznaczeniem. Odrzuca list, nie sprawdza<br>
innych ograniczeñ.<br>
* <b>check_relay_domains</b> - je¶li adres IP komputera, który wysy³a list pasuje<br>
do $relay_domains lub celem listu jest $relay_domains lub to nasz serwer jest <br>
komputerem docelowym - przyjmij list, w przeciwnym wypadku go odrzuæ i zakoñcz.<br>
* <b>permit</b> - pozwól na wys³anie listu. Przydatne na koñcu listy ograniczeñ, jako<br>
   zachowanie domy¶lne, gdy poprzednie regu³y nie pasuj±.<br>
* <b>reject</b> - odrzuæ list. Przydatne na koñcu listy ograniczeñ, jako<br>
   zachowanie domy¶lne, gdy poprzednie regu³y nie pasuj±.<br><br>
Przyk³ady:<br>
<i>smtpd_recipient_restrictions = permit_mynetworks, reject_unauth_destination</i><br>
Jest to warto¶æ domy¶lna ograniczenia.<br>
<i>smtpd_recipient_restrictions = reject_unknown_recipient_domain, <br>
reject_non_fqdn_recipient</i><br>
Nie pozwala wys³aæ listu do nieistniej±cych komputerów docelowych.<br><br>
<b>UWAGA:</b> po ka¿dorazowej zmianie ograniczeñ, nale¿y upewniæ siê, sprawdziæ<br>
czy dzia³aj± one w sposób taki, jaki chcemy. Jest to szczególnie wa¿ne tutaj,<br>
w tej zmiennej.
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="dodatek">Dodatek:</a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
<b>check_xxxxx_access <i>maptype:mapname</i></b><br><br>
W trzech wymienionych wy¿ej restrykcjach (<i>smtpd_recipient_restrictions, <br>
smtpd_client_restrictions, smtpd_sender_restrictions</i>) istnieje mo¿liwo¶æ<br>
zdefiniowania swoistej bazy danych - adresów komputerów i userów oraz <br>
zachowania siê postfixa wzglêdem nich. Przyk³ad definicji takiego pliku:<br><br>
<i>smtpd_recipient_restrictions = check_recipient_access hash:/etc/postfix/odbiorcy</i><br><br>
Plik taki ma bardzo prost± sk³adniê, mianowicie:<br>
user_komp [spacja lub tabulator] co_zrobiæ<br>
Gdzie co_zrobiæ ma warto¶æ: <b>OK</b> ¿eby zaakceptowaæ oraz <b>REJECT</b> aby<br>
odrzuciæ. Zmienna user_komp mo¿e wygl±daæ tak: linio@terramail.pl (nie trzba <br>
chyba wyja¶niaæ), terramail.pl (ka¿dy user@terramail.pl), linio@ (user linio<br>
na ka¿dym mo¿liwym komputerze). Przyk³adowy plik odbiorcy <br>
mo¿e wiêc wygl±daæ tak:<br><br><i>
heniek@ &nbsp;&nbsp;&nbsp; REJECT<br>
tomek@costam.pl &nbsp;&nbsp;&nbsp; REJECT<br>
poczta.pl &nbsp;&nbsp;&nbsp; OK</i><br><br>
Plik ten (/etc/postfix/odbiorcy - dla zmiennej check_recipient_access) <br>
definiuje do kogo listu nie wysy³aæ - nie zostanie on wys³any do ¿adnego<br>
heniek@polska.pl, heniek@dupa.pl, heniek@...... itd, ani do <br>
tomek@costam.pl, kimkolwiek by ten user nie by³.<br>
W analogiczny sposób definiujemy te pliki dla check_sender_access - i tam<br>
mo¿emy sobie zdefiniowaæ od kogo listu nie przyj±æ, smtpd_client_restrictions - <br>
gdzie definiujemy np. od jakich komputerów po³±czenia nie przyj±æ i tak jak to<br>
zrobili¶my przed chwil± - check_recipient_access - dla kogo listów nie dostarczaæ <br>
lub dostarczaæ.<br><br>
Dobra, ¿eby posfix zaskoczy³, nale¿y jeszcze wydaæ polecenie (jako root):<br>
<b>postmap /etc/postfix/odbiorcy</b> i gdy ten zrobi swoje bez b³êdu <br>
(powienien utworzyæ /etc/postfix/odbiorcy.db) robimy <b>postfix reload</b>.<br><br>
 Nale¿y wiedzieæ, ¿e te same prawa mo¿emy ustawiæ na ró¿ne sposoby, jednak <br>
najwa¿niejsze jest to, ¿eby po ka¿dej takiej zmianie sprawdziæ czy wszystko <br>
dzia³a tak jak powinno.  Je¶li nie - szukamy innego sposobu aby odpowiednio <br>
zabezpieczyæ nasz serwer. Sposoby, które przedstawi³em wy¿ej maj± naprawdê <br>
potê¿ne mo¿liwo¶ci i mo¿emy ca³kiem sprytnie z ich pomoc± skonfigurowaæ <br>
komputer, a nie s± to wszystkie mo¿liwo¶ci (jest ich za du¿o...) <br><br>

Jeszcze jedno: mog³em gdzie¶ pope³niæ literówkê - zajrzyj wiêc od czasu <br>
do czasu (szczególnie gdy co¶ nie gra) do /etc/postfix/sample-smtpd.cf.<br>
Ja w ka¿dym razie jestem przekonany, ¿e bêdziesz mia³ z nimi niez³± jazdê - <br>
bêdziesz my¶la³, ¿e wszystko jest o.k. a tu siê oka¿e (znowu), ¿e gdzie¶ <br>
przesadzi³e¶ - ze swojej strony ¿yczê udanej zabawy ;).
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="virtual">12. Wirtualne domeny</a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Te "podstawy konfiguracji" powoli zaczynaj± siê zamieniaæ w "konfiguracjê"...<br>
Dobra. Mo¿e na pocz±tek: czym s± wirtualne domeny? Otó¿ to, ¿e mamy serwerek <br>
i okre¶lon± nazwê nie oznacza, ¿e mo¿emy odbieraæ pocztê tylko dla siebie.<br>
Tak, tak... Nasz serwer (nazwijmy go "jeden.pl") mo¿e odbieraæ pocztê tak¿e <br>
innych komputerów (np. "dwa.pl"). Zastosowanie tego jest chyba oczywiste. <br>
Przyk³ad: je¶li nasza znajoma firma ma SDI, a my mamy Polpaka-T, mo¿emy <br>
robiæ im za serwer poczty. Jedyne, co trzeba za³atwiæ, to wpis w DNS, <br>
¿eby zwraca³ nasz adres przy zapytaniu o pocztê (o ile pamiêtam - rekord MX).<br>
Je¶li to czytasz, zak³adam ¿e wiesz o co chodzi :).<br><br>
<b>Postfix umo¿liwia obs³ugê wirtualnych domen</b>. Dobra, to chyba wiesz. Ale mo¿liwe,<br>
¿e nie wiesz, ¿e umo¿liwia to na dwa sposoby: s± to wirtualne domeny w stylu<br>
Postfixa, drugie: wirtualne domeny w stylu Sendmaila. Czym one siê ró¿ni± - <br>
zapytasz. <b>"Styl Postfixa"</b> polega na tym, ¿e ka¿de konto w wirtualnej domenie<br>
musi mieæ swój wpis. Oznacza to, ¿e je¶li mamy lokalnego u¿ytkownika np. <br>
heniek@jeden.pl, to dla wirtualnej domeny dwa.pl nie istnieje u¿ytkownik<br>
heniek@dwa.pl. Inaczej: wirtualna domena w stylu Postfixa nie istnieje dla<br>
nikogo, dopóki nie utworzymy dla lokalnego u¿ytkownika wpisu, przekierowania.<br>
Musisz utworzyæ wpis dla ka¿dego u¿ytkownika domeny wirtualnej, napisaæ do<br>
jakiego u¿ytkownika lokalnego ma trafiaæ jego poczta.<br><br>
Ju¿ siê pewnie domy¶lasz, ¿e <b>"Styl Sendmaila"</b> polega na tym, ¿e w momencie utworzenia<br>
wirtualnej domeny, automatycznie zaczynaj± istnieæ wszyscy lokalni u¿ytkownicy.<br>
Je¶li masz lokalnych userów hyzio, dyzio, zyzio @jeden.pl, automatycznie otrzymuj±<br>
oni swój drugi adres e-mailowy: hyzio, dyzio, zyzio @dwa.pl.<br>
"Styl Postfixa" ma t± przewagê, ¿e np. root@jeden.pl trafia do jednej osoby, <br>
a root@dwa.pl mo¿e trafiaæ do kogo¶ innego (np. u¿ytkownika heniek). Tak czy <br>
inaczej, wszystko zale¿y od Ciebie - który rodzaj chcesz zastosowaæ. Jeszcze <br>
ma³a uwaga: "styl Sendmaila" jest dostêpny w Postfixie od wersji 20001118.<br><br>
<b>Podsumowuj±c</b>: musisz za³atwiæ jedynie przekierowanie DNS poczty na twój komputer<br>
aby za chwilê (dos³ownie) wszystko zaczê³o dzia³aæ. Styl wirtualnej domeny wybierz<br>
sobie sam - ka¿dy ma swoje wady i zalety, a ich skonfigurowanie Postfixa do ich<br>
obs³ugi jest banalnie proste (zawsze chcia³em tak o czym¶ napisaæ ;).
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="virtual_postfix"><u>12a. Wirtualne domeny w stylu Postfixa </u></a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Dobra. Bierzemy w obroty plik <b>/etc/postfix/main.cf</b> (chyba, ¿e masz gdzie¶ indziej).<br>
JEDYNYM wpisem, który musimy zrobiæ w tym pliku, jest:<br>
<b>virtual_maps = hash:/etc/postfix/virtual</b><br>
Plik, mo¿e siê nazywaæ inaczej. Wa¿na uwaga: NIE zmieniamy w pliku main.cf innych<br>
opcji (takich jak: mydestination, myorigin itp.). <u>Jednym wpisem, dotycz±cym obs³ugi<br>
wirtualnej domeny w main.cf powinien byæ ten element.</u> Przynajmniej w stylu<br>
Postfixa. Jak siê mo¿esz domy¶liæ, zapisujemy zmiany i tworzymy ww. plik, a je¶li <br>
on istnieje, poddajemy go edycji. Komentarze tworzy znak # (hash).<br><br>

Nasz± domen± wirtualn± niech bêdzie: dwa.pl. Obowi±zkowo, w stylu Postfixa, na<br>
pocz±tku tego pliku musi byæ wpis (pierwsza linijka):<br>
 [wirtualna_domena cokolwiek]<br>
 gdzie cokolwiek oznacza jakikolwiek wpis, naprawdê, byle co. W naszym przypadku:<br>
 <b>dwa.pl &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; yeahh_baby</b><br>
 Widaæ, ¿e "yeahh_baby" jest czymkolwiek :)<br><br>

 Teraz mo¿emy sobie normalnie definiowaæ u¿ytkowników domen wirtualnych.<br>
 Poni¿ej przyk³ad, gdzie poczta dla uzytkownika wirtualnego: czesiek trafia<br>
 do u¿ytkownika: heniek, poczta dla wujek idzie do cioci, poczta dla <br>
 billa idzie do kosza a poczta dla roota wirtualnej domeny idzie do jozefa.<br><br>

 <b> dwa.pl &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; yeahh_baby<br>
 czesiek@dwa.pl heniek<br>
 wujek@dwa.pl ciocia<br>
 bill@dwa.pl kosz<br>
 conan@dwa.pl conan<br>
 root@dwa.pl jozef<br></b><br>

 Nie muszê chyba wyja¶niaæ, ¿e lokalni u¿ytkownicy to ciocia, heniek, kosz,<br>
 jozef i conan. Inni lokalni u¿ytkownicy nie maj± adresu w wirtualnej domenie.<br>
 Acha, miêdzy adresem "wirtualnym" a lokalnym u¿ytkownikiem nie ma dwukropka,<br>
 tylko spacja, tabulator itp. Dobra, zapisujemy plik. Pozosta³o wydaæ komendê:<br>
 <b>postmap /etc/postfix/virtual</b><br>
 a nastêpnie prze³adowaæ Postfixa: <b>postfix reload</b>. I to wszystko !
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="virtual_sendmail"><u>12b. Wirtualne domeny w stylu Sendmaila</u></a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Na pocz±tek wrzucamy do edytora plik "main.cf". Tam dopisujemy:<br>
<b>virtual_maps = hash:/etc/postfix/virtual</b><br>
oraz <u>obowi±zkowo</u> dopisujemy do zmiennej <b>$mydestination</b> nazwê naszej<br>
wirtualnej domeny:<br>
<b>$mydestination = $myhostname,......., dwa.pl</b><br><br>

W tym przypadku dopisali¶my "dwa.pl". Oczywi¶cie tworzymy jesli nie istnieje,<br>
lub edytujemy plik "virtual". NIE dajemy na jego pocz±tku wpisu, jak w przypadku<br>
stylu Postfixa, "dwa.pl cokolwiek". Nasz plik virtual, mo¿e wygl±daæ tak:<br><b>
 czesiek@dwa.pl heniek<br>
 wujek@dwa.pl ciocia<br></b><br>

 Tutaj chyba nie muszê wyja¶niaæ, ¿e poczta do wujka "wirtualnego" trafia do<br>
 cioci (u¿ytkownik lokalny) a bill do kosza. Poza tym, <b>ka¿dy u¿ytkownik lokalny<br>
 automatycznie dostaje swój drugi adres e-mailowy</b>. Adres wirtualny. Je¶li<br>
 mamy u¿ytkownika hyzio, od tej pory ma on dwa adresy: hyzio@jeden.pl i hyzio@dwa.pl<br>
 Na tym w³a¶nie polega "styl Sendmaila". Miêdzy adresem "wirtualnym" a lokalnym <br>
 u¿ytkownikiem nie ma dwukropka, tylko spacja, tabulator itp. Zapisujemy plik, wydajemy<br>
 polecenie <b>postmap /etc/postfix/virtual</b> i prze³adowujemy Postfixa:<b>postfix reload</b>.
 <br> Prawdê mówi±c - w zasadzie - pisz±c - to by by³o na tyle.
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="sms">13. Powiadamianie na komórkê (Plus GSM)</a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Tak siê sk³ada, ¿e tylko Plus GSM nie komplikuje ¿ycia swoim abonentom.<br>
I to siê chwali, jednak ceny mogliby trochê obi¿yæ :). Do rzeczy: ka¿dy<br>
posiadacz telefonu w Plusie (dotyczy tak¿e SimPlusa) posiada adres <br>
emailowy nastêpuj±cej postaci: <b>nr_telefonu@text.plusgsm.pl</b>. <br>
Nie muszê chyba dodawaæ, ¿e ka¿da wiadomo¶æ trafiaj±ca pod ten adres,<br>
jest wysy³ana jako SMS do telefonu. ¬li ch³opcy wykorzystuj± to w <br>
niecnym celu, my jednak zrobimy z tego po¿ytek. A po¿ytek wygl±da tak:<br>
dostajemy na serwer nowy list, Postfix go przyjmuje i umieszcza w<br>
skrzynce a przy okazji wysy³a SMSa do odpowiedniej osoby o tre¶ci:<br>
"Nowy list na koncie heniek@serwer.pl", dorzuca do tego SMSa jeszcze<br>
temat listu oraz jego nadawcê. Sposób który zaraz przedstawiê nie jest<br>
mo¿e najlepszym rozwi±zaniem tej sprawy, ale na pewno dzia³a. SMS jest<br>
wys³any od razu po odebraniu poczty, a na telefon przybywa, w zale¿no¶ci od<br>
obci±¿enia serwera Plusa: od jednej sekundy do kilku minut po nadej¶ciu<br>
imejla.<br><br>

&nbsp;&nbsp;&nbsp;&nbsp;Bêdziemy potrzebowaæ programu o nazwie <b>procmail</b>.<br>
Prawdopodobnie masz go na dysku w katalogu "/usr/bin", sprawd¼ to poleceniem<br>
"which procmail". Je¶li go nie masz (w co nie wierzê), pobierz go ze strony<br>
<a href="http://www.procmail.org/">http://www.procmail.org</a>. Mo¿e teraz dwa s³owa<br>
co to w³a¶ciwie jest. Procmail jest "przerabiaczem poczty". To, moim zdaniem,<br>
najlepsze okre¶lenie tego, co potrafi ten program. Niech to wystarczy :)<br>
Jeszcze bêdziemy potrzebowaæ programik o nazwie <b>formail</b>, ale ten<br>
prawdopodobnie jest jednym z elementów procmaila. Standardowo w "/usr/bin".<br><br>
&nbsp;&nbsp;&nbsp;&nbsp;Bierzemy siê do roboty, bo powoli robi siê ciemno ;)<br>
Mo¿e jeszcze jedno: proszê nie przysy³aæ mi pytañ dotycz±cych procmaila,<br>
poniewa¿ nie znam tego programu. Jak bêdziesz potrzebowa³ jakich¶ info,<br>
czytaj dokumentacje i wysy³aj posty na grupy dyskusyjne. Ja tak w³a¶nie robiê.<br><br>

&nbsp;&nbsp;&nbsp;&nbsp;Zaczynamy:<br>
W katalogu /etc/ utwórz plik <b>procmailrc</b>. Jest to g³ówny, domy¶lny plik<br>
konfiguracyjny tego programu. Proponujê umie¶ciæ tam nastêpuj±c± tre¶æ:<br><br>
<b>VERBOSE=on<br>
SHELL=/bin/sh<br>
PMDIR=/etc/procmail/$LOGNAME<br>
LOGFILE=$PMDIR/procmail.log<br>
INCLUDERC=$PMDIR/general.rc<br>
ORGMAIL=/var/spool/mail/$LOGNAME<br>
MAILDIR=$HOME<br>
PROCMAIL_VERSION=666</b><br><br>

Teraz po kolei: VERBOSE - oznacza ¿eby logowa³ to, co czyni. Dobra rzecz.<br>
SHELL - to shell. Nie sprawdza³em z innymi, ni¿ /bin/sh. Jak chcesz siê w to<br>
pobawiæ - proszê bardzo. PMDIR - to katalog konfiguracyjny dla ka¿dego usera.<br>
LOGFILE - tutaj zapisuje co robi. Poniewa¿ ka¿dy user ma swój PMDIR, ³atwo<br>
czytamy co siê dzieje dla ka¿dego usera. INCLUDERC - to bêdzie g³ówny plik<br>
konfiguracyjny, z formatowaniem SMSa, nr telefonu itp. ORGMAIL - czyli gdzie<br>
przechowywana jest poczta po przybyciu. MAILDIR - hmm... PROCMAIL_VERSION - <br>
wpisz tam jakie¶ bzdury, gdyby kto¶ próbowa³ siê za du¿o dowiedzieæ.<br><br>
Jak ju¿ pewnie zauwa¿y³e¶, w katalogu /etc/procmail/ (ju¿ czas go utworzyæ)<br>
bêdz± przechowywane pliki konfiguracyjne i pliki z logami i ca³a reszta. <br>
Ka¿dy user bêdzie mia³ swój katalog, np. /etc/procmail/heniek, /etc/procmail/jojo<br>
itd. Je¶li nie odpowiada tobie po³o¿enie tego katalogu - zmieñ sobie ¶cie¿kê.<br>
I wszystkie inne konsekwentnie. Dobra, pozosta³o naprawdê niewiele teraz.<br><br>

Ja bêdê eksperymentowa³ na u¿ytkowniku "heniek", który ma komórkê w Plusie<br>
o numerze (+48) 603 123456. Przepraszam, osobê do której nale¿y ten numer :)<br>
Tworzymy katalog <b>/etc/procmail/</b>. I kolejny: <b>/etc/procmail/heniek/</b><br>
Pamiêtaj, ¿e mam usera heniek@serwer.pl. Od tej pory u¿ywam Heñka (¿adnych<br>
g³upich skojarzeñ) a Ty odpowiednio go sobie zmieniaj. Pozosta³o tylko <br>
utworzyæ odpowiedni plik w katalogu /etc/procmail/heniek/. Je¶li cofniesz siê<br>
parê linijek wy¿ej powiniene¶ wyczaiæ, ¿e ten plik to (zmienna INCLUDERC):<br>
<b>general.rc</b>. Tak wiêc tworzymy tam sobie taki plik. A jego tre¶æ ?<br>
Dla u¿ytkownika heniek@moj.serwer.pl z nr telefonu: 603123456 wygl±da tak:<br><br>
<b>:0 c<br>
* ^From*<br>
| formail -X Subject: -X From: |mail -s "Nowy email na koncie" 48603123456@text.plusgsm.pl
<br><br></b>
Nale¿y uwa¿aæ na znaczki, dlatego teraz<br>
s³ownie: dwukropek zero [spacja] ce (pierwsza linia), gwiazdka [spacja]<br>
"górny daszek" From gwiazdka(druga linia), "pionowa kreska" - jak ta przy<br>
tworzeniu potoków - [spacja] minus du¿yIks spacja... a dalej to ju¿ widzisz.<br>
Ale b³azenada. Pamiêtaj tutaj o du¿ych literach przy Subject i From, i o tym,<br>
¿e po tych wyrazach s± dwukropki. Wa¿ne: nie stawiaj plusa (+) przed numerem<br>
telefonu bo SMS nie dojdzie. To i tyle... prawie tyle. Jeszcze jeden szczegó³.<br>
Co robi general.rc: ka¿dy list który wpada, od kogokolwiek, jest obrabiany tak:<br>
wytnij z niego temat (Subject) i nadawce (From) i razem z "Nowy email na koncie"<br>
wy¶lij to wszystko (docelowo dojdzie jako SMS) na podany adres emailowy (ten<br>
z nr telefonu). Tia. Jeszcze jedna wa¿na rzecz. W sumie najwa¿niejsza, bo bez<br>
tego ani rusz: nale¿y powiedzieæ Postfixowi, ¿eby zacz±³ u¿ywaæ procmaila.<br><br>
Tradycyjnie: wrzucamy do edytora plik <b>/etc/postfix/main.cf</b> i tam szukamy<br>
zmiennej <b>mailbox_command</b>. Je¶li takowej nie ma, sami sobie tworzymy i <br>
robimy taki wpis:<br><b>
mailbox_command = /usr/bin/procmail<br></b>
¦cie¿kê mo¿esz mieæ inn±, ale o tym wiesz. Dobra, teraz: <b>postfix reload</b><br>
i szafa gra. A przynajmniej powinna graæ :)<br><br>
A wszystko dzia³a tak: postfix przyjmuje maila do henka. Widzi, ¿e trzeba u¿yæ<br>
procmaila. A wiêc go uruchamia. Procmail czyta /etc/procmailrc i widzi, ¿eby<br>
co¶ zrobi³. A co ? A to, co jest w /etc/procmail/heniek/general.rc. Tak wiêc<br>
procmail to robi i bez wzglêdu na to, czy mu siê uda czy te¿ nie wynik swojej<br>
dzia³alno¶ci zapisuje w /etc/procmail/heniek/procmail.log a nastêpnie koñczy<br>
pracê. W tym czasie Postfix zd±¿y³ ju¿ od³o¿yæ ¶wie¿± pocztê do odpowiedniego<br>
katalogu i wszyscy s± szczê¶liwi.<br><br>
Teraz na powa¿nie: nie jestem specjalist± od procmaila i zdajê sobie sprawê z <br>
tego, ¿e pewne rzeczy tutaj s± nadmiarowe. Je¶li wiesz, jak mo¿na to wszystko<br>
upro¶ciæ, przy¶lij mi imejla. Wskazówka dla Ciebie: pewnie nie mo¿esz doczekaæ<br>
siê ju¿ SMSa :) ¯eby siê upeniæ czy wszystko posz³o ok zobacz do pliku z logami:<br>
/etc/procmail/twoj_login/procmail.log. Kolejna wskazówka: plik general.rc<br>
napisz tylko raz, a dla kolejnych userów skopiuj go w odpowiednie miejsce,<br>
zmieniaj±c tylko nr telefonu.
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="gg">14. Powiadamianie na GaduGadu</a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Pawe³ Pa³ka jest autorem programu <b>GateGaduDeamon (ggdaemon)</b> <br>
do informowania o nowych mailach na odpowiedni numer GG. <br>
Wszystkie informacje na temat softu mo¿na znale¼æ na <br>
jego stronie domowej: <a href="http://rex.olsnet.eu.org/">http://rex.olsnet.eu.org</a>
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="mks">15. Postfix + MKS vir</a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
O ochronie antywirusowej wiele ju¿ powiedziano i nie mam zamiaru dodawaæ<br>
nic od siebie. Mo¿e tylko tyle: administrator musi czasami my¶leæ za<br>
u¿ytkowników.<br><br>
Od pewnego czasu firma Mks vir udostêpnia swój program antywirusowy<br>
(jeden z najlepszych jakie znam) tak¿e na Linuxa. I robi to z klas±:<br>
u¿ywanie programu pod tym systemem nic nie kosztuje. Tak trzymaæ !<br>


Program ten jest ci±gle w (intensywnej) wersji rozwojowej. Trwaj± prace<br>
nad jego demonizacj±, wspó³prac± z Amavisem i kilkoma innymi pozytywnymi<br>
rzeczami. Dla ch³opaków pracuj±cych nad tym sk³adam wielkie DZIÊKI.<br><br>

Sposób, który tutaj opisuje uruchamia mksa przez procmaila. Ma to kilka<br>
istotnych wad, z których najwa¿niejsz± jest spore obci±¿enie procesora.<br>
Warto, aby¶ to wiedzia³. Odsy³am do dokumentacji dostarczonej razem z<br>
Mksem. Mo¿na wyczytaæ tam kilka ciekawych rzeczy, linków itp.<br><br>
Do rzeczy: program mo¿na pobraæ ze strony mksa: <a href="http://linux.mks.com.pl/">http://linux.mks.com.pl</a>.<br>
Je¶li link nie bêdzie dzia³a³, poszukaj softu przez <a href="http://www.mks.com.pl/">stronê g³ówn±</a><br>
Do tego, co opisujê, wystarczy pobraæ plik <b>mkslinux.tgz</b>. O ile jego <br>
nazwa siê nie zmieni :) Testowa³em to wszystko na wersji <b>1.3beta</b><br><br>
Instalacja (w skrócie, mo¿e siê zmieniæ w nastêpnej wersji programu).<br>
a) rozpakowujesz kod ¼ród³owy, wchodzisz do ¶rodka<br>
b) tworzysz jaki¶ katalog (np. /usr/local/mks/) i wszystko tam przerzucasz<br>
c) wchodzisz do tego katalogu i czytasz dokumentacjê...<br>
d) domy¶lny plik konfiguracyjny to /etc/mks_vir: <br>
   <b>cp mks.cfg /etc/mks_vir.cfg</b><br>
e) edytujesz tak powsta³y /etc/mks_vir.cfg i odhaszowujesz to:<br>
--mks-vir-dat-path=/usr/local/mks/<br>
<i>wa¿ny slesz na samym koñcu katalogu i w³a¶ciwa ¶cie¿ka do niego</i><br>
--scan<br>
<i>mo¿esz wybraæ sobie co¶ innego, tylko wiedz CO wybierasz</i><br>
Zapisujesz zmiany.<br>
f) tworzysz link symboliczny do pliku mks32, np. tak:<br>
<b>ln -s /usr/local/mks/mks32 /usr/local/bin/mks32<br></b>
g) Teraz mo¿esz sprawdziæ, czy program dzia³a, np. tak:<br>
<b>mks32 <i>nazwa_jakiego¶_pliku<br></i></b>
Powiniene¶ zobaczyæ kilka ciekawych linijek wyj¶ciowych. Jeszcze raz<br>
zachêcam do czytania dokumentów dostarczonych z mks'em - s± po polsku :)<br><br>


Teraz powiniene¶ mieæ dzia³aj±cego mksa. Na zwyk³ych plikach, przetestuj go<br>
z wirusami, poczytaj jak aktualizowaæ jego bazê danych wirusów i takie tam.<br>
Bierzemy siê za Postfixa. Jak napisa³em wcze¶niej, bêdzie on wywo³ywa³ mksa<br>
przez procmaila. Dla wszyskich u¿ytkowników, niezale¿nie od ich woli.<br>
Jeszcze jedna uwaga: jak ju¿ pewnie siê domy¶li³e¶ skanowana bêdzie tylko<br>
poczta przychodz±ca do u¿ytkowników. Dobra:<br>
na pocz±tek musisz mieæ dzia³aj±cego <b>procmaila</b>, uruchamianego<br>
przez Postfixa, gdy przychodzi poczta. Opisa³em to wy¿ej, przy okazji<br>
powiadamiania SMSem o nowej poczcie. W skrócie:<br>
a) w main.cf masz wpis: <b>mailbox_command=/usr/bin/procmail</b><br>
chyba ¿e u Ciebie znajduje siê on w innym miejscu.<br>
b) plik <b>/etc/procmailrc</b> to g³ówny plik konfiguracyjny procmaila.<br>
Wystarczy, ¿e w jego zmiennych masz:<br><b>
SHELL=/bin/sh<br></b>
i na koñcu, po innych zmiennych w stylu VERBOSE, MAILDIR itp. umieszczasz<br>
czarodziejskie linijki:<br><b>
:0<br>
*<br>
| mks32 -e 1&gt;&gt;$ORGMAIL 2&gt;&gt;/var/log/mks.log<br></b>
<i>S³ownie: dwukropek zero [Enter] gwiazdka [Enter] "pipe" mks32...</i><br><br>

Musisz jeszcze utworzyæ plik z logami (/var/log/mks.log) i daæ wszyskim<br>
u¿ytkownikom prawa do jego zapisu. Procmail dzia³a jako user i musi mieæ<br>
mo¿liwo¶æ zapisu do logów. Zrób to, przynajmniej na pocz±tku, ¿eby widzieæ<br>
czy jest o.k., czy skanuje pocztê. Potem mo¿esz logi przekierowaæ do /dev/null<br>
je¶li nie chcesz ich ogl±daæ. Chocia¿ warto wiedzieæ, co siê tam dzieje...<br><br>
A je¶li nie bêdzie odpowiednich praw do logów, mks32 po³o¿y laskê na skanowanie i <br>
pu¶ci plik z wirusem. To wszystko, testuj !<br><br>

Jeszcze raz zaznaczam, ¿e to wersja rozwojowa i czêsto siê zmienia.<br>
Mks przysy³a fajny komunikat, gdy znajdzie wirusa.<br>
Gdy bêdzie mo¿na fajnie po³±czyæ go z Amavisem, napiszê o tym.<br>
Pamiêtaj, ¿eby uaktualniaæ bazê danych wirusów w miarê czêsto.<br>
Jak co¶ nie gra, CZYTAJ LOGI. Logi dla procmaila mo¿esz utworzyæ<br>
przez tak± zmienn± (w /etc/procmailrc):<br>
LOGFILE=$HOME/procmail.log<br>
w katalogu domowym usera, do którego przychodzi poczta bêdzie zapisywa³<br>
co jest grane...
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="stat">16. Statystyki dla Postfixa</a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Ten fragment pisany jest bez polskich literek.<br>
Dobra, zacznijmy od poczatku. Kazdy chyba wie, co to sa statystyki.<br>
Bardzo dobrze sprawdzaja sie one wtedy, gdy przez nas serwer przechodzi<br>
stosunkowo duzo poczty. Od logow az oczy bola... Po pierwsze,<br>
musisz wiedziec gdzie Postfix zapisuje swoje logi. U mnie jest to plik<br>
/var/adm/mail_in.log. Nie musze chyba przypominac, ze takie rzeczy<br>
ustawia sie w pliku /etc/syslog.conf (np. mail.* /var/adm/mail_in.log).<br>
Jesli tam spojrzysz, zobaczysz calkiem spory bajzel. Oczywiscie po<br>
chwili sie polapiesz co, skad, od kogo i do kogo zostalo wyslane.<br>
Czy nie byloby prosciej, gdybys dostal to wszystko od razu na tacy ?<br><br>
Znalazlem w Sieci bardzo fajny program, napisany w Perlu. Nazywa sie<br>
on <b>pflogsumm.pl</b> i mozna go pobrac, oraz poczytac o nim
<a href="http://jimsun.linxnet.com/postfix_contrib.html">tutaj</a>.<br>
W chwili gdy to pisze, aktualna, stablina wersja to 0.9.<br>
 Oprocz tego, bedziemy potrzbowali oczywiscie Perla (wersja <br>
chyba 5.003 przynajmniej) oraz modulu dla niego <b>Date::Calc</b>, ktory
mozna <br>sobie sciagnac z <a href="http://www.cpan.org/">www.cpan.org</a> lub z
jakiegos jego mirrora.<br><br>
Jesli masz Perla, sciagasz sobie Date::Calc (Date-Calc) i po rozpakowaniu<br>
wchodzisz do jego katalogu oraz wydajesz komende:<br><br><i>
perl Makefile.PL<br>
make<br>
make test<br>
make install</i><br><br>
Zakladam, ze wszystko poszlo dobrze, bo nie o Perlu tutaj chce pisac. W razie<br>
klopotow, rzuc okiem do pliku Install.txt. Okey, mamy Perla, Date::Calc<br>
udalo sie dorzucic do niego, pozostal nasz <b>pflogsumm.pl</b>. Jest to<br>
plik tekstowy (to dla tych, ktorzy nie wiedza), patrzymy na jego poczatek<br>
(poleceniem np. <i> head pflogsumm.pl</i>) i patrzymy czy sciezka do <br>
perla zgadza sie z nasza sciezka (<i>which perl</i>) i jak nie, to zmieniamy<br>
ja w tym pliku. Plik programu musi byc oczywiscie wykonywalny (atrybut x)<br>
a osoba ktora go wywoluje musi miec oczywiscie prawa do czytania logow :)<br><br>
Pokaze tutaj wywolanie programu tak, jak ja go uzywam. Nie jest on <br>
niebezpieczny i proponuje samemu sie pobawic w inne jego opcje.<br>
Zasada wywolania jest taka<br><i>
./pflogsum.pl -d [dzien] [sciezka do pliku]</i><br>
Ja wywoluje go dodatkowo z opcja -e (chyba od extended) i w sumie mam tak:<br><br><b>
./pflogsum.pl -e -d yesterday /var/adm/mail_in.log</b><br><br>
Czyli program wypisze mi rozszerzone (-e) statystyki poczty z<br>
wczoraj (-d yesterday) a dane bedzie bral z pliku /var/adm/mail_in.log.<br><br>
Teraz czas na zlozenie wszystkiego do kupy. Jest godzina czwarta w nocy, userzy<br>
dawno spia, a na serwie z crona wywolane jest codziennie:<br>
<b>pflogsum.pl -e -d yesterday /var/adm/mail_in.log | mail -s "Statystyka<br>
wczorajszej poczty" admin@localhost<br></b><br>
Czy to nie fajne ? Codziennie rano czeka na mnie w skrzynce list ze statystyka<br>
wczorajszej poczty. Program pflogsumm bardzo fajnie ja przedstawia z<br>
opcja -e. Tak wiec rano loguje sie, biore lyka kawy, wlaczam pine, zapalam papierosa<br>
i czytam sobie statysyke poczty... co i Tobie polecam.
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="error">17. Oczekuj±c na b³±d</a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Sprawa wygl±da tak: kto¶ ³±czy siê przez telnet z portem 25 serwera poczty<br>
i zaczyna wpisywaæ dziwne komendy zaczerpniête z hakierskich FAQ. To nic<br>
¿e dotycz± one Sendmaila, to nic ¿e Sendmaila wersji 0.09, to nic ¿e<br>
Postfixowi taki hakier mo¿e naskoczyæ. Ka¿dego normalnego admina <br>
takie zagrywki po prostu denerwuj±. Po wpisaniu takiej debilnej komendy<br>
po pewnym czasie zwracany jest b³±d, kolejny b³±d, kolejny... w koñcu<br>
serwer zamyka po³±czenie mówi±c dzieciakowi "na drzewo !". Aby zniechêciæ<br>
amatorstwo do takiej zabawy mo¿emy wyd³u¿yæ czas zwrócenia komunikatu o<br>
b³êdzie oraz przyspieszyæ roz³±czenie.<br><br>

<b>smtpd_error_sleep_time</b> - definiuje czas w sekundach, po którym<br>
zwracany jest komunikat o b³êdzie. Domy¶lnie ma warto¶æ 5 (sekund).<br>
Nie ma co w tym miejscu przesadzaæ, poniewa¿ z za³o¿enia ma on chroniæ<br>
normalnych u¿ytkowników poczty, których "prymitywne" klieci poczty<br>
mog± wpa¶æ w pêtle: po³±cz - wy¶lij - roz³±cz. Na skutek b³êdu<br>
oczywista, gdy nie zostanie wys³ana poczta, programy kliencie mog±<br>
na upartego znowu siê ³±czyæ i próbowaæ wys³aæ to samo. Tak wiêc opcja<br>
ta dotyczy zarówno "telnetowców - kombinatorów", jak i normalnych<br>
u¿ytkowników, którzy mog± czekaæ na komunikat o b³êdzie wieczno¶æ.<br>
Domy¶lne piêæ sekund wydaje siê byæ tutaj ca³kiem sensown± warto¶ci±.<br>
Zmiana na trzy sekundy:<br><br><i>
smtpd_error_sleep_time = 3</i><br><br>

<b>smtpd_soft_error_limit</b> to bardzo ciekawy parametr. Domy¶lnie ma<br>
on warto¶æ 10, co oznacza, ¿e po przekroczeniu 10 b³êdów w czasie<br>
jednego po³±czenia, komunikat o b³êdzie zwracany jest po liczbie<br>
b³êdów sekund. Ja¶niej: gdy w czasie jednego po³±czenia, wyst±pi<br>
10 b³êdów, komunikat o b³êdzie zwracany jest co 5 sekund (dok³adniej:<br>
co <i>smtpd_error_sleep_time</i> sekund). Gdy wyst±pi 11 raz, komunikat<br>
o b³êdzie pojawi siê po 11 sekundach, gdy b³±d wyst±pi 12 raz, komunikat<br>
o b³êdzie pojawi siê po 12 sekundach i tak dalej. Poniewa¿ wyst±pnienie<br>
wiêcej ni¿ 3 b³êdów w czasie jednego po³±czenia jest raczej nienormalne<br>
dlatego warto¶æ t± mo¿na ustawiæ np. na 3. Czwarty b³±d zostanie zwrócony<br>
po 4 sekundach, 5 po piêciu itd.:<br><br><i>
smtpd_soft_error_limit = 3</i><br><br>


<b>smtpd_hard_error_limit</b> - domy¶lna warto¶æ to 100. Definiuje on po<br>
ilu b³êdach po³±czenie zostanie przerwane. Nic dodaæ, nic uj±æ. Je¶li kto¶<br>
nie chce siê bawiæ w <i>smtpd_soft_error_limit</i>, mo¿e od razu ustawiæ<br>
t± warto¶æ na np. 5. Nie nale¿y przesadzaæ, poniewa¿ czasy i b³êdy ww. <br>
dotycz± tak¿e zwyk³ych, nie¶wiadomych u¿ytkowników, których klienci <br>
poczty s± niew³a¶ciwie skonfigurowane, przestarza³e a na linii dochodzi<br>
do zak³óceñ. Przyk³ad, gdy po 5 b³êdach po³±czenie jest zamkniête:<br><br><i>
smtpd_hard_error_limit = 5</i><br><br>

Zasada jest taka: czasy i liczby do ww. parametrów ustalaj w podanej wy¿ej<br>
kolejno¶ci, uwa¿aj ¿eby nie przesadziæ. Nale¿y pamiêtaæ, ¿e 2-3 b³êdy mog± <br>
przydarzyæ siê normalnym u¿ytkownikom, powy¿ej nich mo¿na albo bawiæ siê w <br>
opó¼nianie albo szybko zamkn±æ po³±czenie i pozbyæ siê buraka.
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="jaki">18. Jaki serwer ?</a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Jest wielce prawdopodobne, ¿e bêdziesz chcia³ ukryæ nazwê i wersjê swojego<br>
serwera poczty przed innymi. Oto kilka wskazówek:<br><br>

* Serwer poczty dzia³a standardowo na 25 porcie.<br>
Po wydaniu polecenia <i>telnet localhost 25</i> zobaczymy dane naszego<br>
programu pocztowego. O ile my to wiemy bez telnetu, to dobrze by by³o gdyby<br>
inni tego nie widzieli. Komunikat, który jest wy¶wietlany po po³±czeniu <br>
z serwerem poczty, mo¿na zmieniæ, wpisuj±c do pliku main.cf zmienn± <br>
<b>smtpd_banner</b> i nadaj±c mu odpowiedni± warto¶æ. Proponujê: <br><br>
<i>smtpd_banner = $hostname ESMTP</i><br><br>

* Je¶li kto¶ otrzyma pocztê z naszego serwera, to i tak w nag³ówku znajdzie<br>
"Postfix". Jak to zmieniæ ? S³u¿y do tego parametr <b>mail_name</b>. Po zmianie<br>
jego warto¶ci, w nag³ówku listu pojawi siê ten w³a¶nie serwer. Czyli:<br><br>
<i>mail_name = Microsoft ShittyServer 2.6</i><br><br>

Teraz to wszystko funkcjonuje ca³kiem przyzwoicie. Zawodowcy Twój<br> serwer poczty
sprawdziliby wysy³aj±c list do u¿ytkownika, który nie istnieje.<br> Dostaliby
odpowied¼: "<i>This is the Microsoft ShittyServer 2.6 at ....</i>".<br> Fajnie,
ale w czê¶ci drugiej tego listu pojawi³aby siê sekcja:<br><i>
Diagnostic-Code: X-Postfix;.....</i><br><br>

Jedynym rozwi±zaniem tego problemu, z tego co mi wiadomo, jest zmiana kawa³ka<br>
kodu w pliku <b>/¶cie¿ka/do_kodu/¼ród³owego/src/bounce/bounce_notify_util.c</b><br>
W tym¿e pliku na sztywno jest zdefiniowny <i>X-Postfix</i>. Albo nale¿y wyci±æ<br>
ten fragment albo zmieniæ go np. na <i>X-Qmail</i>. Po kompilacji i ponownej<br>
instalacji programu nie otrzymamy ju¿ tego fragmentu (lub otrzymamy zmieniony :).<br><br>

Mo¿e to spowodowaæ sytuacjê, w której u¿ytkownik - hakier spotyka nas i mówi:<br>
<i>"Ale ty ich robisz w wa³a. My¶l±, ¿e masz serwer Micro$oftu ale ja i tak wiem,<br>
¿e masz Qmaila"</i>. Oczywi¶cie mo¿emy go pochwaliæ: <i>"Sk±d o tym wiesz ?"</i>.<br>
A co, niech ma co¶ od ¿ycia...<br><br>

Zmiana kodu ¼ród³owego to ju¿ wy¿sza szko³a jazdy, nie wiem czy przy okazji <br>
nie ingeruje ona w zasady licencjonowania programu (zmiana kodu i takie tam).<br>
Tak czy siak, zabawa jest fajna...
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="inne">19. Inne</a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
* Razem z postfixem dostarczany jest taki fajny programik: <b>postsuper</b>.<br>
Ta na co ? Ano s³u¿y on okresowemu sprawdzaniu naszego serwera poczty <br>
tj. sprawdza jego strukture, kasuje niepotrzebne ju¿ pliki i w ogóle robi<br>
 porz±dki. Aby to uczyni³ nale¿y (jako root) wydaæ polecenie <br><br>
<i>postsuper -s -p</i>. Najlepiej wrzuciæ to sobie do crona (u mnie raz na 24h).<br><br>
Kolejnym ciekawym zastosowaniem <b>postsuper</b> jest mo¿liwo¶æ usuwania<br>
wys³anych a nie dostarczonych maili (czyli takich, które s± w kolejce<br>
i nie opu¶ci³y jeszcze serwera):<br><br>
<i>postsuper -d [ID listu]</i><br>
<i>postsuper -d ALL</i><br><br>
Oczywi¶cie drugie polecenie usuwa wszystkie listy z kolejki. Pierwsze natomiast<br>
list o konkretnym ID (polecenie <b>mailq</b> przychodzi tu z pomoc±). <br>THX dla
Macieja M. z SEB TFI S.A.
<br><br>

* Ciekawym parametrem jest maksymalny rozmiar wiadomo¶ci, jaki nasz serwer <br>
mo¿e przyj±æ (razem z za³±cznikiem). Wielko¶æ t± ustawiamy
wpisuj±c do <br> pliku main.cf parameter <b>message_size_limit</b> oraz podaj±c ow±
 wielko¶æ w bajtach.<br> Przyk³adowo, ustawmy j± na ok. 5MB:<br><br>
<i>message_size_limit = 5000000</i><br><br>

* Inny parametr - <b>mailbox_size_limit</b> - pozwala ustawiæ ilo¶æ miejsca <br>
na wszystkie listy u¿ytkownika, czyli pojemno¶æ skrzynki pocztowej.<br>
 Jest to swojego rodzaju "quota" skrzynki
pocztowej userów. <br>Podawana jest (¿eby skomplikowaæ ¿ycie) w bajtach,
a jej<br>
domy¶lna wielko¶æ to 50MB (czyli 51200000).<br> Aby to zmieniæ na np. 100MB
wpisujemy:<br><br><i>
mailbox_size_limit = 102400000</i><br><br>

* Je¶li nasze listy obrabiane s± przez <b>procmail</b>, nale¿y w pliku<br>
/etc/postfix/main.cf wprowadziæ zmienn± <b>mailbox_command</b> i nadaæ<br>
jej waro¶æ procmaila (wraz ze ¶cie¿k± dostêpu). Czyli:<br><br><i>
mailbox_command = /usr/bin/procmail<br><br></i>

* Opcja <b>smtpd_recipient_limit</b> okre¶la maksymaln± liczbê odbiorców<br>
jednego listu. Czêsto userzy wysy³aj± ten sam list (np. z kawa³ami lub<br>
du¿ymi za³±cznikami) do wielu osób na raz. Wykorzystuj± oczywi¶cie pola<br>
CC i BCC swojego klienta pocztowego. Domy¶lnie zmienna ta ma warto¶æ<br>
1000, co mo¿e byæ w ca³o¶ci wykorzystane tylko przez spamerów. Sensown± <br>
wydaje siê byæ warto¶æ np. 50, a wiêc:<br><br><i>smtpd_recipient_limit = 50</i><br><br>


* "<i>Nie wytrzymam, permanentna inwigilacja</i>" czyli <b>always_bcc</b>.<br>
Ta opcja z olei okre¶la adresata, do którego zostanie wys³ana kopia ka¿dego<br>
listu przes³anego przez postfixa. Innymi s³owy, ka¿dy list - czy wychodz±cy,<br>
czy przychodz±cy przez nasz serwer - zostanie wys³any nie tylko do w³a¶ciwego<br>
odbiorcy, ale tak¿e pod zdefiniowany przez nas adres. Pamiêtaj, aby szanowaæ<br>
prywatno¶æ swoich userów... Tak czy siak, aby kopia ka¿dego listu przechodz±cego<br>
przez nasz serwer trafi³a do czesiu@uop.pl nale¿y dopisaæ:<br><br><i>
always_bcc = czesiu@uop.pl</i><br><br>

* "<i>Stary, nie ¶wiruj</i>", czyli <b>queue_minfree</b>.<br>
Jednym z nielicznych przypadków, kiedy Linux zaczyna wariowaæ, jest brak<br>
miejsca na dysku - której¶ z u¿ywanych przez system partycji. Tak± jest np.<br>
/var/spool/. Tam te¿ przewa¿nie wrzucana jest nowa poczta. Aby uniemo¿liwiæ<br>
postfixowi zape³nienie partycji, do której wrzuca on pocztê, mo¿na zdefiniowaæ<br>
ilo¶æ wolnego miejsca na dysku, którego postfix nie mo¿e przekroczyæ.<br>
Inaczej: dopóki miejsca jest wiêcej ni¿ <i>queue_minfree</i> postfix dostarcza<br>
pocztê. Je¶li tego miejsca jest mniej, postfix odmawia przyjêcia nowej poczty<br>
dla u¿ytkownika oraz informuje o tym odpowiedni± osobê (domy¶lnie<br>
informuje o tym <i>postmaster</i>a). Domy¶lnie ta opcja ta jest wy³±czona, co<br>
oznacza, ¿e postfix mo¿e zapachaæ now± poczt± ca³± partycjê. Dobra, aby<br>
zostawiæ minimalnie ok. 10MB wolnego miejsca nale¿y wpisaæ (jednostk± s± bajty):<br>
<br><i>queue_minfree = 10000000</i><br><br>

* Opró¿niæ kolejkê...<br>
Czasem bywa tak, ¿e zdalny, docelowy serwer do poczty nie odpowiada (chodzi<br>
pod Window$em i siê zawiesi³), nie mo¿na do niego dotrzeæ (TPsa znowu daje <br>
dupy) lub ju¿ go nie ma (zwolnili admina z roboty, wiêc on im po³o¿y³ pocztê).<br>
Gdy Postfix nie mo¿e dostarczyæ poczty, kolejkuje j± u siebie i co jaki¶<br>
czas sprawdza, czy zdalny siê nie pojawi³. Tylko co jaki czas i kiedy zwaraca<br>
do nadawcy listu informacjê, ¿e nie mo¿e dostarczyæ poczty ? Otó¿ odpowiednio:<br>
<b>queue_run_delay</b> oraz <b>maximal_queue_lifetime</b>. Standardowo jest<br>
to 1000 sekund dla pierwszego i 5 dni dla drugiego. Jednostki tych opcji<br>
to <b>s</b> (sekundy), <b>m</b> (minuty), <b>h</b> (godziny), <b>d</b> (dni) oraz <b>w</b> (tygodnie).<br>
Przyk³adzik: spradzaj zdalnego co pó³ godziny i zwracaj b³±d do nadawcy<br>
po trzech dniach:<br><br><i>
queue_run_delay = 30m<br>
maximal_queue_lifetime = 3d
</i><br><br>

* Poczta w sieci lokalnej<br>
Gdy w Twojej domowej sieci zainstalujesz 2 serwery poczty, pewnie chcia³by¶<br>
sobie przesy³aæ miêdzy nimi pocztê, eksperymentowaæ, poznawaæ Postfixa...<br>
Wystarczy wtedy odpowiedni wpis w /etc/hosts, zmiana paru linijek w main.cf<br>
i... <b>ignore_mx_lookup_error</b>. Tak jest, Postfix nie dostarczy poczty,<br>
dopóki nie otrzma z DNSu rekordu MX (poczta) dla zdalnego serwera. Najlepszym<br>
objawem tego jest taki zapis w logach: <i>Name service error for: ...... Host<br>
not found, try again</i>. Przypomnê tylko, ¿e nie nale¿y w³±czaæ tej opcji,<br>
gdy nasz Postfix jest normalnym serwerem poczty w Internecie dla jakiej¶<br>
domeny....<br><br><i>
ignore_mx_lookup_error = yes</i><br><br>

* G³upi "b³±d"<br>
Gdy nasz Postfix dzia³a dobrze, ba: wzorowo, w logach mo¿e pojawiaæ siê co¶<br>
takiego: <i>NIS domain name not set - NIS lookups disabled</i>.<br>
Pewnie i tak nie korzystasz z NIS, ale Postfix domy¶lnie zak³ada, ¿e to robisz.<br>
I nie przekonasz wa³a, ¿e nie, dopóki nie u¿yjesz <b>alias_maps</b>. Sêk tkwi<br>
w tym, ¿e jedn± z warto¶ci tego parametru jest <i>nis:mail.aliases</i>, gdy w<br>
przypadku braku NIS wystarczy $alias_database :<br><br><i>
alias_maps = $alias_database</i><br><br>

* Kolekcjoner spamu<br>
Je¶li chcia³by¶ przechwytywaæ ca³± pocztê przychodz±c± dla u¿ytkowników,<br>
którzy w systemie nie istniej±, powiniene¶ skorzystaæ z parametru<br>
<i>luser_relay</i>. Mo¿esz w ten sposób wyczajaæ spamerów i zapobiec odbijaniu<br>
poczty z interesuj±cymi danymi w nag³ówkach. Du¿ym minusem jest fakt,<br>
¿e je¶li osoba z zewn±trz pope³ni³a literówkê w adresie odbiorcy - nie<br>
dowie siê o tym, ¿e list nie dotar³ do adresata. Przyk³ad:<br><br>
<i>luser_relay = czesiek</i><br>
<i>luser_relay = czesiek@brzeszczot.pl</i><br><br>

* Bramka pocztowa<br>
Je¶li ca³± pocztê wychodz±c± z naszego serwerka chcemy wysy³aæ<br>
za po¶rednictwem innego serwa (takiego, na którym np. dzia³a<br>
program antywirusowy lub np. nasz jest blokowany na firewallu)<br>
powinni¶my u¿yæ <i>relayhost</i>. Wówczas ka¿dy email wychodz±cy<br>
z naszego komputera przekazywany jest w³a¶nie do niego:<br><br><i>

relayhost = antywirus.firma.pl</i><br><br>

* Ukryæ wafli<br>
Mamy serwer poczty dla okre¶lonej domen(y), np. firma.pl. Jest w niej<br>
kilka serwerów pocztowych, ludzie ró¿nie konfiguruj± Outlooki :).<br>
Je¶li chcemy, ¿eby ka¿dy email wychodz±cy z naszego kompa mia³ w <br>
adresie nadawcy po "ma³pce" okre¶lony adres, np. firma.pl a nie<br>
mail.firma.pl lub poczta.firma.pl wykorzystujemy:<br>
<i> masquerade_domains = firma.pl</i><br><br>
Wszystkie farmazony za "ma³p±" podane przez u¿ytkowników zostan±<br>
zast±pione przez nasz± domenê g³ówn±.<br>
Je¶li dopuszczamy tylko mail.firma.pl i firma.pl: <br>
<i> masquerade_domains = mail.firma.pl firma.pl</i><br>
W tym przypadku mail.firma.pl jest przepuszczona przez nasz serwerek,<br>
natomiast wszystkie inne domeny (np. poczta.firma.pl) s± zamienione na firma.pl.<br><br>

Pojawia siê w tym momencie pewien problem. Jak w takiej sytuacji<br>
odró¿niæ wiadomo¶æi które pochodz± od <i>admin@mail1.firma.pl</i> od tych,<br>
pochodz±cych od <i>admin@mail2.firma.pl</i>, które przychodz± do nas ?<br>
Komu odpisaæ, skoro w skrzynce zobaczymy <i>admin@firma.pl</i> ?<br>
Ano skorzystaæ opcji, która definiuje loginy u¿ytkowników dla których<br>
maskowanie domen jest pomijane. Na przyk³ad tak: <br><i>
masquerade_exceptions = admin, root</i>
<br><br>

* Co w kolejce siedzi ?<br>
Polecenie <b>mailq</b> poka¿e nam kolejke. BTW: ten sam wynik zwróci<br>
<b>postqueue -p</b>. Wiemy wiêc, co czeka na wys³anie. Gdy jednak<br>
spojrzysz do pliku z wiadomo¶ci± (<i>/var/spool/postfix/......</i>)<br>
zobaczysz co ? ¦mieci. ¯eby odczytaæ skolejkowan± wiadomo¶æ, pos³u¿<br>
siê poleceniem <b>postcat</b>. Na przyk³ad tak:<br><i>
postcat /var/spool/postfix/deferred/0/0/004BB2C024 |more </i>
<br><br>


<br><u>Dobre rady wujka Heñka:</u><br><br>
* Sprawdzajcie co jaki¶ czas skolejkowan± pocztê (<b>mailq</b>),<br>
czytajcie logi generowane przez postfixa.<br><br>
* Nie zmieniajcie na raz wielu opcji. Zmieñcie jedn±, zapiszcie<br>
zmiany i sprawd¼cie czy wszystko dzia³a jak nale¿y. Róbcie kopie<br>
zapasowe plików konfiguracyjnych !!!<br><br>
* Na <a href="http://linio.terramail.pl/">mojej stronie</a> znajduje
siê opis jak skonfigurowaæ <br>
Postfixa z SASL'em. Je¶li jeste¶ zainteresowany - zapraszam.
<br><br><br>
</font></td></tr>

<tr><td bgcolor="black"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="tls">20. Postfix + TLS</a>
</font></td></tr>
<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Ten punkt powinien byæ o wiele wy¿ej, ale nie chce pogubiæ siê w linkach na stronie...<br>
Jak wszyscy wiemy, komunikacja na drodze klient - serwerSMTP (Outlook - Postfix :)<br>
nie jest szyfrowana. Jest to norma. Gdy pojawia siê autoryzacja przy wysy³aniu poczty,<br>
tak¿e has³o juzera leci otwartym tekstem (w wiêkszo¶ci przypadków). Mo¿e wypada³oby<br>
wprowadziæ szyfrowanko ? Takie w tle, na wzór SSH zastêpuj±cego telnet. Rozwi±zanie<br>
takie istnieje i nazywa siê TLS (ang. <i>Transportation Layer Security</i>) - czyli SSL na SMTP.<br>
Mo¿e z powodzeniem <u>zast±piæ tunelowanie poczty</u> wychodz±cej (od klientów- Outlook itp.).<br>
Mniejsza z tym, wa¿ne ¿e jest i dzia³a. Aby poprawnie toto zainstalowaæ nale¿y znaæ<br>
a) wersjê Postfixa, b) wersjê OpenSSL. Nasz TLS dostêpny jest jako patch nak³adany<br>
oczywi¶cie na ¼róde³ka Postifxa. Dla ka¿dej nowej wersji Postfixa wychodzi nowy pacz<br>
napisany pod konkretn±, ostatni± wersjê OpenSSLa. Chce powiedzieæ, ¿e musisz mieæ<br>
odpowiedniego Postfixa i OpenSSLa lub apgrejdowaæ które¶ z nich. Najlepiej od razu<br>
wejd¼ pod adres i pobierz aktualn± wersjê softu:<br><br>

<a href="http://www.aet.tu-cottbus.de/personen/jaenicke/postfix_tls/">http://www.aet.tu-cottbus.de/personen/jaenicke/postfix_
tls/</a><br><br>

W chwili gdy pisa³em ten punkt, aktualnymi wersjami by³y: postfix-2.1.3 oraz openssl-0.9.7d.<br>
Patch nazywa siê wiêc: pfixtls-0.8.18-2.1.3-0.9.7d.tar.gz. Mamy wiêc: <br>
pfixtls-<i>wersja_pacza-wersja_postfixa-wersja_openssl</i>.tar.gz.<br><br>

Jedna wa¿na rzecz: zak³adam, ¿e OpenSSL zosta³ zainstalowany w <i>/usr/local/ssl</i>. Je¶li<br>
masz go gdzie¶ indziej - musisz odpowiednio zmieniaæ ¶cie¿ki, szukaæ pliki itp.<br>
Byæ mo¿e bêdziesz
musia³ co¶ apgrejdowaæ. Okej, przechodzimy do sedna. Zak³adam, ¿e mamy zainstalowane<br>
OpenSSL, rozpakowane ¼róde³ka postfixa i patcha. Wchodzimy do katalogu z Postfixem i wydajemy<br>
polecenie:<br><br><b>

cd postfix-2.1.3/<br>
patch -p1 &lt; ../pfixtls-0.8.18-2.1.3-0.9.7d/pfixtls.diff<br></b><br>

Powiniene¶ zobaczyæ seriê komunikatów w stylu "<i>patching file .....</i>". Dobra, jedziemy<br>
dalej. Dalej jest kompilacja Postfixa:<br><br><b>

make makefiles CCARGS="-DUSE_SSL -I/usr/local/ssl/include" AUXLIBS="-L/usr/local/ssl/lib -lssl -lcrypto"</b><br><br>

A pó¼niej to ju¿ tylko <i>make &amp; make install </i>. Je¶li dodatkowo Postfix ma wspieraæ<br>
autoryzacje (SASL), dopisujesz dodatkowe parametry do <i>CCARGS</i> oraz <i>AUXLIBS</i>.<br>
Za³o¿y³em, ¿e OpenSSL zosta³ zainstalowany w domy¶lnym katalogu (instalacja ze ¼róde³):<br>
<i>/usr/local/ssl/</i>. <br><br>

Pozosta³y jeszcze dwie rzeczy: konfiguracja w <i>main.cf</i> oraz wygenerowanie kluczy.<br>
Omówie to w takiej kolejno¶ci, bo mi tak wygodniej. Ty najpierw wygeneruj klucze, dopiero<br>
potem zmieniaj konfig (nie musze mówiæ dlaczego :).<br><br>

Dopisz takie rzeczy do <i>/etc/postfix/main.cf</i>:<br><br><b>

# w³±czamy TLS<br>
smtpd_use_tls = yes<br>
smtp_tls_note_starttls_offer = yes<br>
# krótkie info diagnostyczne dla nas<br>
smtpd_tls_loglevel = 1<br>
# mo¿emy wymusiæ TLS przy Autoryzacji ("yes" wymaga SASL)<br>
smtpd_tls_auth_only = no<br>
# ¼ród³o "losowo¶ci"<br>
tls_random_source = dev:/dev/urandom<br>
# klucz<br>
smtpd_tls_key_file = /etc/ssl/postfix/key.pem<br>
# publiczny certyfikat postfixa<br>
smtpd_tls_cert_file = /etc/ssl/postfix/cert.pem<br>
# publiczny certyfikat CA<br>
smtpd_tls_CAfile = /etc/ssl/postfix/ca.pem
</b><br><br>

Klucze. Czas wygenerowaæ certyfikaty. W naszym konfigu za³o¿yli¶my, ¿e trzymamy je<br>
w <i>/etc/ssl/postfix/</i>. OpenSSL, ze ¼róde³ek instaluje siê w <i>/usr/local/ssl</i>.<br>
Je¶li masz go gdzie¶ indziej - znajd¼: szukaj pliku <i>CA.sh</i>.<br><br>

Najpierw musisz zostaæ CA:<br><b>
cd /usr/local/ssl/misc/<br>
./CA.sh -newca<br><br></b>
Przyjmij domy¶ln± nazwê pliku, gdy zapyta.<br>
Wymy¶l i zapamiêtaj has³o. Wpisz dane, dowolne, instytucji podpisuj±cej certyfikaty.<br>
W ten sposób, w podkatalogu <i>demoCA/</i> znajdzie siê plik <b>cacert.pem</b>.<br>
Je¶li nie istnieje katalog <i>/etc/ssl/postfix</i>, utwórz go/je a nastêpnie skopiuj tam<br>
ten plik pod nazw± <b>ca.pem</b> (jak w konfigu):<br><br><b>

cd /usr/local/ssl/misc/demoCA/<br>
cp cacert.pem /etc/ssl/postfix/ca.pem</b><br><br>

Pozosta³o wygenerowaæ i podpisaæ certyfikat dla naszego Postfixa.<br><br><b>

cd /usr/local/ssl/misc/<br>
../bin/openssl req -new -nodes -keyout key.pem -out newreq.pem<br>
mv key.pem /etc/ssl/postfix/<br><br></b>

W momencie gdy pyta o <i>Common Name</i> nale¿y wpisaæ nazwê serwera poczty.<br>
Gdy pyta o adres imejlowy, dobrze jest wpisaæ adres admina poczty.<br>
Gdy pyta o 'extra' parametry - nie wpisujemy nic, walimy w Enter.<br>
Pozosta³o podpisaæ certyfikat:<br><br><b>

./CA.sh -sign<br>
mv newcert.pem /etc/ssl/postfix/cert.pem<br><br></b>

Pyta o has³o - chodzi mu o has³o CA - to, które przed chwil± wymy¶li³e¶.<br>
Gdy w tym momencie siê wykrzaczy, sprawd¼, czy w zmiennej <i>PATH</i> masz ¶cie¿kê<br>
do <i>/usr/local/ssl/bin/</i>. A jak nie, to: <i>export PATH=$PATH:/usr/local/ssl/bin</i><br>
Jeszcze tylko postprz±tamy...<br><br><b>

rm newreq.pem<br>
chmod 0600 /etc/ssl/postfix/*<br><br></b>

Có¿ mogê dodaæ, czas odpaliæ toto i patrzeæ w logi...<br>
Je¶li wygl±da normalnie - jest dobrze. Teraz telnetuj siê na port 25 swojego serwera i <br>
zobacz, czy po wpisaniu <i>ehlo [nazwa twojego kompa] /Enter/</i> zobaczysz <i>STARTTLS</i>.<br>
Je¶li tak jest - jest jeszcze lepiej.<br><br>

Pozosta³o sprawdziæ to w praniu... Outlook -&gt; Narzêdzia -&gt; Konta -&gt; W³a¶ciwo¶ci -&gt; Zaawansowane<br>
i postaw haczyk przy "Ten serwer wymaga bezpiecznego po³±czenia (SSL)". Port siê nie <br>
zmienia, pozostaje 25. Spróbuj co¶ wys³aæ, patrz w logi, kliknij OK na ostrze¿enie.<br>
Powinno wszystko lataæ. Od czasu do czasu mo¿esz zobaczyæ w logach, jak miêdzy <br>
serwerami poczty komunikacja przebiega z u¿yciem TLS (chyba wp.pl ma toto w³±czone).
<br><br><br>
</font></td></tr>

<tr><td bgcolor="blue"><font style="font-family: Verdana,Arial,Helvetica;" color="white" size="2">
<a name="poslo"><b>Pos³owie</b></a>
</font></td></tr>

<tr><td><font style="font-family: Verdana,Arial,Helvetica;" size="2"><br>
Jest to druga wersja dokumentu i zawiera pewnie<br>
jakie¶ b³êdy/niedoróbki/potkniêcia itp. Bêdê bardzo wdziêczny<br>
za wszelkie uwagi, komentarze, poprawki, wyrazy wdziêczno¶ci.<br>
Z góry przepraszam za powy¿sze i mam nadziejê, ¿e bêdziecie mnie<br>
informowaæ w których miejscach co¶ nie gra.<br>
Jako (czê¶ciowe) wyt³umaczenie przedstawiam fakt, ¿e wiêkszo¶æ tej<br>
pracy powstawa³a w pó¼nych godzinach nocnych.<br><br>
Ostatnia wersja tego dokumentu znajduje siê pod ni¿ej wymienionym adresem.<br>
Kontakt ze mn±: <a href="mailto:linio@terramail.pl">linio@terramail.pl</a><br>
Wesprzyj finansowo autora - kliknij <a href="http://linio.terramail.pl/datki.html">tutaj</a>
<br><br><br>&nbsp;</font></td></tr>

<tr><td align="center">
<font style="font-family: Verdana,Arial,Helvetica;" color="blue" size="2">
===============================<br>
 Henryk Liniowski, Poznañ 2004<br>
<a href="http://linio.terramail.pl/">http://linio.terramail.pl</a><br>
===============================<br></font></td></tr>

</tbody></table></center></body></html>